# ç´¹ä»‹åˆ¶åº¦å®Ÿè£…è¨ˆç”»æ›¸ v2ï¼ˆæ¡ˆA: PremiumGrantçµ±ä¸€ç®¡ç†ç‰ˆï¼‰

**æ›´æ–°æ—¥**: 2025-10-23  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: æœ€çµ‚ç¢ºå®šã€æ¡ˆAæ¡ç”¨  
**å„ªå…ˆåº¦**: é«˜  
**æ¨å®šå·¥æ•°**: 12ã€œ15æ—¥ï¼ˆ1åæƒ³å®šã€ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å«ã‚€ï¼‰

---

## 0. ã‚¨ã‚°ã‚¼ã‚¯ãƒ†ã‚£ãƒ–ã‚µãƒãƒªãƒ¼

### ç›®çš„
æœ‰æ–™è»¢æ›ç‡ã‚’æœ€å„ªå…ˆã§å‘ä¸Šã•ã›ã€æŒç¶šå¯èƒ½ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ç²å¾—ã‚’å®Ÿç¾ã™ã‚‹ã€‚

### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®é‡è¦å¤‰æ›´
**User.plan ã‚’å»ƒæ­¢ã—ã€PremiumGrant ã§ãƒ—ãƒ¬ãƒŸã‚¢ãƒ çŠ¶æ…‹ã‚’çµ±ä¸€ç®¡ç†**

- å¾“æ¥: `User.plan (FREE/STANDARD)` ã§ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ç®¡ç†
- æ–°è¦: `PremiumGrant` ãƒ†ãƒ¼ãƒ–ãƒ«ã§ç´¹ä»‹/èª²é‡‘ã®ä¸¡æ–¹ã‚’ç®¡ç†
- **ç†ç”±**: ç´¹ä»‹ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ï¼ˆ14æ—¥/30æ—¥ï¼‰ã¨èª²é‡‘ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ï¼ˆ1å¹´ï¼‰ã‚’çµ±ä¸€çš„ã«æ‰±ã†ãŸã‚

### ãƒªãƒ¯ãƒ¼ãƒ‰è¨­è¨ˆï¼ˆæœ€çµ‚ç¢ºå®šç‰ˆï¼‰
- **å‹ã ã¡ï¼ˆè¢«ç´¹ä»‹è€…ï¼‰**: ç™»éŒ²æ™‚ã«å³æ™‚**14æ—¥é–“**ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ä»˜ä¸
- **ç´¹ä»‹è€…**: å‹ã ã¡ãŒ**3æ—¥é€£ç¶šãƒ­ã‚°é”æˆ**ã§**30æ—¥é–“**ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ä»˜ä¸ï¼ˆäººæ•°ç„¡åˆ¶é™ï¼‰
- **è¡¨ç¾**: ã€Œå‹ã ã¡1äººã§30æ—¥å»¶é•·ã€
- **ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ç‰¹å…¸**: 
  - æœˆé–“ã‚«ãƒ­ãƒªãƒ¼å·®åˆ†è¡¨ç¤º
  - AIä½¿ç”¨åˆ¶é™ç·©å’Œï¼ˆ1æ—¥3å› â†’ 20å›ï¼‰
  - **éå»90æ—¥ã®å±¥æ­´ä¿å­˜**ï¼ˆç„¡æ–™ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯30æ—¥ã®ã¿ï¼‰

### KPI
- **ä¸»è¦**: 30æ—¥ä»¥å†…ã®æœ‰æ–™åŒ–ç‡ï¼ˆç´¹ä»‹çµŒç”±ï¼‰
- **æ¬¡ç‚¹**: Kä¿‚æ•°ï¼ˆç›®æ¨™**â‰¥0.5**ã€æˆç†ŸæœŸ0.8ã€œ1.0ï¼‰ã€æ–°è¦ç™»éŒ²æ•°

### ã‚¹ã‚³ãƒ¼ãƒ—
- **Phase 1**: iOSå…ˆè¡Œã€åŸºæœ¬æ©Ÿèƒ½å®Ÿè£… + æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ã®ç§»è¡Œï¼ˆ12ã€œ15æ—¥ï¼‰
- **Phase 2**: ä¸æ­£æ¤œçŸ¥å¼·åŒ–ã€Analyticsçµ±åˆï¼ˆ3æ—¥ï¼‰
- **Phase 3**: Androidå¯¾å¿œã€Universal Linkså¯¾å¿œï¼ˆ4æ—¥ï¼‰

---

## 1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

### 1.1 æ—¢å­˜ãƒ†ãƒ¼ãƒ–ãƒ«ã®å¤‰æ›´

#### âœ… ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ: `User` ãƒ¢ãƒ‡ãƒ«ä¿®æ­£

**å‰Šé™¤**:
- [x] `User.plan` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å‰Šé™¤
- [x] `UserPlan` enum ã‚’å‰Šé™¤

**è¿½åŠ **:
- [x] `User.referralsMade` ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¿½åŠ ï¼ˆ1å¯¾å¤šã€Referralã¸ï¼‰
- [x] `User.referredBy` ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¿½åŠ ï¼ˆ1å¯¾1ã€Referralã¸ï¼‰
- [x] `User.premiumGrants` ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¿½åŠ ï¼ˆ1å¯¾å¤šã€PremiumGrantã¸ï¼‰
- [x] `User.inviteLinks` ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¿½åŠ ï¼ˆ1å¯¾å¤šã€ReferralInviteLinkã¸ï¼‰

**ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å‰ã®ç¢ºèª**:
- [x] æ—¢å­˜ã® `User.plan = STANDARD` ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°ã‚’ç¢ºèªï¼ˆèª²é‡‘æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰
- [x] ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ PremiumGrant ã«å¤‰æ›ã™ã‚‹è¨ˆç”»ã‚’ä½œæˆ

```prisma
model User {
  id             Int              @id @default(autoincrement())
  email          String           @unique
  username       String?
  passwordHash   String
  // plan        UserPlan         @default(FREE)  // â† å‰Šé™¤
  aiCredits      Int              @default(0)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  mealLogs       MealLog[]
  ingestRequests IngestRequest[]
  edits          MealLogEdit[]
  shareTokens    LogShareToken[]
  favoriteMeals  FavoriteMeal[]
  usageCounters  AiUsageCounter[]
  iapReceipts    IapReceipt[]
  profile        UserProfile?
  premiumGrants  PremiumGrant[]   // â† è¿½åŠ 
  referralsMade  Referral[]       @relation("ReferrerRelation")  // â† è¿½åŠ 
  referredBy     Referral?        @relation("ReferredRelation")  // â† è¿½åŠ 
  inviteLinks    ReferralInviteLink[]  // â† è¿½åŠ 
}

// enum UserPlan {  // â† å‰Šé™¤
//   FREE
//   STANDARD
// }
```

### 1.2 æ–°è¦ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ

#### âœ… ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ: `PremiumGrant` ãƒ†ãƒ¼ãƒ–ãƒ«

```prisma
model PremiumGrant {
  id          Int             @id @default(autoincrement())
  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      Int
  source      PremiumSource
  days        Int
  startDate   DateTime
  endDate     DateTime
  referral    Referral?       @relation(fields: [referralId], references: [id])
  referralId  Int?
  iapReceipt  IapReceipt?     @relation(fields: [iapReceiptId], references: [id])
  iapReceiptId Int?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@index([userId, endDate])
  @@index([source])
}

enum PremiumSource {
  REFERRAL_FRIEND    // å‹ã ã¡ã¨ã—ã¦æ‹›å¾…ã•ã‚ŒãŸï¼ˆ14æ—¥ï¼‰
  REFERRAL_REFERRER  // ç´¹ä»‹è€…ã¨ã—ã¦ç²å¾—ï¼ˆ30æ—¥ï¼‰
  PURCHASE           // èª²é‡‘è³¼å…¥ï¼ˆ365æ—¥ï¼‰
  ADMIN_GRANT        // ç®¡ç†è€…ä»˜ä¸
}
```

- [x] Prismaã‚¹ã‚­ãƒ¼ãƒã« `PremiumGrant` ãƒ¢ãƒ‡ãƒ«ã‚’è¿½åŠ 
- [x] `PremiumSource` enum ã‚’è¿½åŠ 
- [x] `User`, `Referral`, `IapReceipt` ã¨ã®é–¢é€£ã‚’è¨­å®š
- [x] ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
- [ ] ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œï¼ˆdev, staging, prodï¼‰

#### âœ… ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ: `Referral` ãƒ†ãƒ¼ãƒ–ãƒ«

```prisma
model Referral {
  id                Int       @id @default(autoincrement())
  referrerUser      User      @relation("ReferrerRelation", fields: [referrerUserId], references: [id], onDelete: Cascade)
  referrerUserId    Int
  referredUser      User      @relation("ReferredRelation", fields: [referredUserId], references: [id], onDelete: Cascade)
  referredUserId    Int       @unique
  status            ReferralStatus  @default(PENDING)
  friendPremiumGranted Boolean @default(false)
  referrerPremiumGranted Boolean @default(false)
  consecutiveDaysAchieved Int   @default(0)
  deviceFingerprint String?
  completedAt       DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  premiumGrants     PremiumGrant[]

  @@index([referrerUserId])
  @@index([status])
  @@index([deviceFingerprint])
}

enum ReferralStatus {
  PENDING      // å‹ã ã¡ç™»éŒ²æ¸ˆã¿ã€3æ—¥é€£ç¶šæœªé”æˆ
  COMPLETED    // 3æ—¥é€£ç¶šé”æˆã€ç´¹ä»‹è€…ã«ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ä»˜ä¸æ¸ˆã¿
  EXPIRED      // 30æ—¥çµŒéã—ã¦ã‚‚æœªé”æˆ
  FRAUD        // ä¸æ­£ã¨åˆ¤å®š
}
```

- [x] Prismaã‚¹ã‚­ãƒ¼ãƒã« `Referral` ãƒ¢ãƒ‡ãƒ«ã‚’è¿½åŠ 
- [x] `ReferralStatus` enum ã‚’è¿½åŠ 
- [x] `deviceFingerprint` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¿½åŠ ï¼ˆä¸æ­£æ¤œçŸ¥ç”¨ï¼‰
- [x] ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
- [ ] ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ

#### âœ… ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ: `ReferralInviteLink` ãƒ†ãƒ¼ãƒ–ãƒ«

```prisma
model ReferralInviteLink {
  id          Int       @id @default(autoincrement())
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      Int
  code        String    @unique  // çŸ­ç¸®ã‚³ãƒ¼ãƒ‰ï¼ˆä¾‹: "A3K9Px"ï¼‰
  clickCount  Int       @default(0)
  signupCount Int       @default(0)
  createdAt   DateTime  @default(now())
  lastUsedAt  DateTime?

  @@index([userId])
  @@index([code])
}
```

- [x] Prismaã‚¹ã‚­ãƒ¼ãƒã« `ReferralInviteLink` ãƒ¢ãƒ‡ãƒ«ã‚’è¿½åŠ 
- [x] ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
- [ ] ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ

#### âœ… ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ: `IapReceipt` ãƒ¢ãƒ‡ãƒ«ä¿®æ­£

```prisma
model IapReceipt {
  // ... æ—¢å­˜ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
  premiumGrants PremiumGrant[]  // â† è¿½åŠ 
}
```

- [x] `IapReceipt` ã« `premiumGrants` ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¿½åŠ 
- [x] ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
- [ ] ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ

---

## 2. æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¨ˆç”»

### 2.1 ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆä½œæˆ

#### âœ… ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ: ãƒ‡ãƒ¼ã‚¿ç§»è¡Œ

- [x] `apps/server/scripts/migrate_user_plan_to_premium_grant.ts` ä½œæˆ
- [x] æ—¢å­˜ã® `User.plan = STANDARD` ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æŠ½å‡º
- [x] å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã« `PremiumGrant` ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆ
  - source: `PURCHASE`
  - days: 365
  - startDate: æœ€å¤ã® IapReceipt.purchasedAt ã¾ãŸã¯ User.createdAt
  - endDate: startDate + 365æ—¥
- [ ] ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œå‰ã«æœ¬ç•ªãƒ‡ãƒ¼ã‚¿ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
- [ ] ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
- [ ] æœ¬ç•ªç’°å¢ƒã§å®Ÿè¡Œ

#### ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆä¾‹

```typescript
// apps/server/scripts/migrate_user_plan_to_premium_grant.ts
import { PrismaClient, UserPlan, PremiumSource } from '@prisma/client';
import { DateTime } from 'luxon';

const prisma = new PrismaClient();

async function migrateUserPlanToPremiumGrant() {
  console.log('Starting User.plan â†’ PremiumGrant migration...');

  // STANDARD ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—
  const standardUsers = await prisma.user.findMany({
    where: { plan: UserPlan.STANDARD },
    include: {
      iapReceipts: {
        orderBy: { purchasedAt: 'asc' },
        take: 1, // æœ€å¤ã®è³¼å…¥ãƒ¬ã‚³ãƒ¼ãƒ‰
      },
    },
  });

  console.log(`Found ${standardUsers.length} STANDARD users`);

  let migrated = 0;
  let errors = 0;

  for (const user of standardUsers) {
    try {
      const startDate = user.iapReceipts[0]?.purchasedAt ?? user.createdAt;
      const endDate = DateTime.fromJSDate(startDate).plus({ days: 365 }).toJSDate();

      // æ—¢ã« PremiumGrant ãŒã‚ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
      const existingGrant = await prisma.premiumGrant.findFirst({
        where: { userId: user.id, source: PremiumSource.PURCHASE },
      });

      if (existingGrant) {
        console.log(`User ${user.id} already has a PremiumGrant, skipping`);
        continue;
      }

      // PremiumGrant ä½œæˆ
      await prisma.premiumGrant.create({
        data: {
          userId: user.id,
          source: PremiumSource.PURCHASE,
          days: 365,
          startDate,
          endDate,
          iapReceiptId: user.iapReceipts[0]?.id,
        },
      });

      migrated++;
      console.log(`Migrated user ${user.id} (${user.email})`);
    } catch (error) {
      console.error(`Error migrating user ${user.id}:`, error);
      errors++;
    }
  }

  console.log(`Migration completed: ${migrated} migrated, ${errors} errors`);
}

migrateUserPlanToPremiumGrant()
  .catch((e) => {
    console.error(e);
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
  });
```

- [x] ã‚¹ã‚¯ãƒªãƒ—ãƒˆä½œæˆ
- [ ] ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã§ãƒ†ã‚¹ãƒˆ
- [ ] æœ¬ç•ªç’°å¢ƒã§å®Ÿè¡Œ
- [ ] å®Ÿè¡Œãƒ­ã‚°ã‚’ä¿å­˜

---

## 3. æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã®ä¿®æ­£

### 3.1 PremiumService æ–°è¦ä½œæˆ

#### âœ… ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ: `apps/server/src/services/premium-service.ts`

```typescript
// apps/server/src/services/premium-service.ts
// ãƒ—ãƒ¬ãƒŸã‚¢ãƒ çŠ¶æ…‹ã‚’åˆ¤å®šãƒ»ç®¡ç†ã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹
// PremiumGrantãƒ†ãƒ¼ãƒ–ãƒ«ã‚’å‚ç…§ã—ã¦ãƒ—ãƒ¬ãƒŸã‚¢ãƒ çŠ¶æ…‹ã‚’åˆ¤å®š
// é–¢é€£: ai-usage-service, log-cleanup, iap-service

import { prisma } from '../db/prisma.js';
import { PremiumSource } from '@prisma/client';
import { DateTime } from 'luxon';

export interface PremiumStatus {
  isPremium: boolean;
  source: PremiumSource | null;
  daysRemaining: number;
  expiresAt: Date | null;
}

export async function isPremium(userId: number): Promise<boolean> {
  const activeGrant = await prisma.premiumGrant.findFirst({
    where: {
      userId,
      startDate: { lte: new Date() },
      endDate: { gte: new Date() },
    },
    orderBy: { endDate: 'desc' },
  });
  return activeGrant !== null;
}

export async function getPremiumStatus(userId: number): Promise<PremiumStatus> {
  const activeGrant = await prisma.premiumGrant.findFirst({
    where: {
      userId,
      startDate: { lte: new Date() },
      endDate: { gte: new Date() },
    },
    orderBy: { endDate: 'desc' },
  });

  if (!activeGrant) {
    return {
      isPremium: false,
      source: null,
      daysRemaining: 0,
      expiresAt: null,
    };
  }

  const now = DateTime.now();
  const expiresAt = DateTime.fromJSDate(activeGrant.endDate);
  const daysRemaining = Math.ceil(expiresAt.diff(now, 'days').days);

  return {
    isPremium: true,
    source: activeGrant.source,
    daysRemaining,
    expiresAt: activeGrant.endDate,
  };
}

export async function getAllPremiumGrants(userId: number) {
  return prisma.premiumGrant.findMany({
    where: { userId },
    orderBy: { createdAt: 'desc' },
  });
}

export async function grantPremiumDays(params: {
  userId: number;
  source: PremiumSource;
  days: number;
  referralId?: number;
  iapReceiptId?: number;
}): Promise<void> {
  const now = new Date();
  const endDate = DateTime.fromJSDate(now).plus({ days: params.days }).toJSDate();

  await prisma.premiumGrant.create({
    data: {
      userId: params.userId,
      source: params.source,
      days: params.days,
      startDate: now,
      endDate,
      referralId: params.referralId,
      iapReceiptId: params.iapReceiptId,
    },
  });
}
```

- [x] `premium-service.ts` ã‚’æ–°è¦ä½œæˆ
- [x] `isPremium()` å®Ÿè£…
- [x] `getPremiumStatus()` å®Ÿè£…
- [x] `grantPremiumDays()` å®Ÿè£…
- [x] `getAllPremiumGrants()` å®Ÿè£…
- [x] `filterPremiumUserIds()` å®Ÿè£…
- [x] `getAllPremiumUserIds()` å®Ÿè£…
- [ ] ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆä½œæˆï¼ˆå„ªå…ˆåº¦: ä¸­ï¼‰

### 3.2 AIä½¿ç”¨åˆ¶é™ã‚µãƒ¼ãƒ“ã‚¹ã®ä¿®æ­£

#### âœ… ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ: `apps/server/src/services/ai-usage-service.ts`

**ä¸»è¦ãªå¤‰æ›´**:

```typescript
// ä¿®æ­£å‰
import { UserPlan } from '@prisma/client';
const DAILY_LIMITS: Record<UserPlan, number> = {
  FREE: 3,
  STANDARD: 20,
};

// ä¿®æ­£å¾Œ
import { isPremium } from './premium-service.js';
const DAILY_LIMITS: Record<'FREE' | 'PREMIUM', number> = {
  FREE: 3,
  PREMIUM: 20,
};

export async function evaluateAiUsage(userId: number): Promise<AiUsageStatus> {
  const user = await prisma.user.findUnique({
    where: { id: userId },
    select: { aiCredits: true },
  });

  if (!user) {
    throw new Error('AI åˆ©ç”¨çŠ¶æ³ã®ç¢ºèªå¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
  }

  const premiumUser = await isPremium(userId);
  const plan = premiumUser ? 'PREMIUM' : 'FREE';
  const limit = DAILY_LIMITS[plan];

  // ... æ®‹ã‚Šã®ãƒ­ã‚¸ãƒƒã‚¯
}
```

- [x] `UserPlan` import ã‚’å‰Šé™¤
- [x] `isPremium()` ã‚’ä½¿ã£ã¦ãƒ—ãƒ¬ãƒŸã‚¢ãƒ åˆ¤å®š
- [x] `DAILY_LIMITS` ã®å‹ã‚’å¤‰æ›´
- [x] `resolveTierOverride()` ã«å¤‰æ›´ï¼ˆUSER_TIER_OVERRIDEç’°å¢ƒå¤‰æ•°ã‚’ä½¿ç”¨ï¼‰
- [x] ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆä¿®æ­£
- [x] çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆCIé€šéï¼‰

### 3.3 ãƒ­ã‚°ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚¸ãƒ§ãƒ–ã®ä¿®æ­£

#### âœ… ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ: `apps/server/src/jobs/log-cleanup.ts`

**ä¸»è¦ãªå¤‰æ›´**:

```typescript
// ä¿®æ­£å‰
import { UserPlan } from '@prisma/client';

await prisma.mealLog.deleteMany({
  where: {
    deletedAt: null,
    createdAt: { lt: cutoff },
    user: { plan: UserPlan.FREE },
  },
});

// ä¿®æ­£å¾Œ
const FREE_RETENTION_DAYS = 30;
const PREMIUM_RETENTION_DAYS = 90;

export async function purgeExpiredMealLogs(referenceDate: Date = new Date()) {
  const now = DateTime.fromJSDate(referenceDate).setZone(CLEANUP_TIMEZONE);
  const freeUserCutoff = now.minus({ days: FREE_RETENTION_DAYS }).toJSDate();
  const premiumUserCutoff = now.minus({ days: PREMIUM_RETENTION_DAYS }).toJSDate();
  const deletionCutoff = now.minus({ days: DELETION_GRACE_DAYS }).toJSDate();

  // ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®IDãƒªã‚¹ãƒˆã‚’å–å¾—
  const premiumUserIds = await prisma.premiumGrant.findMany({
    where: {
      startDate: { lte: now.toJSDate() },
      endDate: { gte: now.toJSDate() },
    },
    select: { userId: true },
    distinct: ['userId'],
  });

  const premiumIds = new Set(premiumUserIds.map((g) => g.userId));

  const [softDeleted, freeExpired, premiumExpired] = await Promise.all([
    // Soft-deleted logsï¼ˆ30æ—¥å¾Œã«å®Œå…¨å‰Šé™¤ï¼‰
    prisma.mealLog.deleteMany({
      where: {
        deletedAt: { not: null, lt: deletionCutoff },
      },
    }),

    // ç„¡æ–™ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ­ã‚°ï¼ˆ30æ—¥å¾Œã«å‰Šé™¤ï¼‰
    prisma.mealLog.deleteMany({
      where: {
        deletedAt: null,
        createdAt: { lt: freeUserCutoff },
        userId: { notIn: Array.from(premiumIds) },
      },
    }),

    // ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ­ã‚°ï¼ˆ90æ—¥å¾Œã«å‰Šé™¤ï¼‰
    prisma.mealLog.deleteMany({
      where: {
        deletedAt: null,
        createdAt: { lt: premiumUserCutoff },
        userId: { in: Array.from(premiumIds) },
      },
    }),
  ]);

  return {
    softDeleted: softDeleted.count,
    freeExpired: freeExpired.count,
    premiumExpired: premiumExpired.count,
  };
}
```

- [x] `UserPlan` import ã‚’å‰Šé™¤
- [x] ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ¦ãƒ¼ã‚¶ãƒ¼IDå–å¾—ãƒ­ã‚¸ãƒƒã‚¯è¿½åŠ 
- [x] ç„¡æ–™/ãƒ—ãƒ¬ãƒŸã‚¢ãƒ åˆ¥ã®å‰Šé™¤å‡¦ç†å®Ÿè£…
- [x] `PREMIUM_RETENTION_DAYS = 90` ã‚’è¿½åŠ 
- [x] ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆä¿®æ­£
- [x] çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆCIé€šéï¼‰

### 3.4 èª²é‡‘è³¼å…¥ã‚µãƒ¼ãƒ“ã‚¹ã®ä¿®æ­£

#### âœ… ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ: `apps/server/src/services/iap-service.ts`

**ä¸»è¦ãªå¤‰æ›´**:

```typescript
// ä¿®æ­£å¾Œ
import { grantPremiumDays } from './premium-service.js';

export async function processIapPurchase(params: ProcessPurchaseParams): Promise<...> {
  // ... ãƒ¬ã‚·ãƒ¼ãƒˆæ¤œè¨¼

  await prisma.$transaction(async (tx) => {
    const receipt = await tx.iapReceipt.create({
      data: {
        userId: params.userId,
        platform,
        productId: verification.productId,
        transactionId: verification.transactionId,
        environment: verification.environment,
        quantity: verification.quantity,
        creditsGranted,
        status: 'VERIFIED',
        purchasedAt: verification.purchaseDate,
        payload: verification.raw as any,
      },
    });

    await tx.user.update({
      where: { id: params.userId },
      data: { aiCredits: { increment: creditsGranted } },
    });

    // â˜… æ–°è¦è¿½åŠ : PremiumGrantä½œæˆï¼ˆ1å¹´é–“ï¼‰
    await tx.premiumGrant.create({
      data: {
        userId: params.userId,
        source: 'PURCHASE',
        days: 365,
        startDate: new Date(),
        endDate: DateTime.now().plus({ days: 365 }).toJSDate(),
        iapReceiptId: receipt.id,
      },
    });
  });

  // ... æ®‹ã‚Šã®ãƒ­ã‚¸ãƒƒã‚¯
}
```

- [x] PremiumGrantä½œæˆï¼ˆ1å¹´é–“ã€365æ—¥ï¼‰
- [x] `User.plan` æ›´æ–°å‡¦ç†ã‚’å‰Šé™¤
- [x] ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆä¿®æ­£
- [x] çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆCIé€šéï¼‰

### 3.5 èªè¨¼ã‚µãƒ¼ãƒ“ã‚¹ã®ä¿®æ­£

#### âœ… ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ: `apps/server/src/services/auth-service.ts`

**ä¸»è¦ãªå¤‰æ›´**:

```typescript
// ä¿®æ­£å‰
function serializeUser(user: {
  id: number;
  email: string;
  username: string | null;
  plan: UserPlan;
  aiCredits: number;
}) {
  return {
    id: user.id,
    email: user.email,
    username: user.username ?? undefined,
    plan: user.plan,
    aiCredits: user.aiCredits,
  };
}

// ä¿®æ­£å¾Œ
function serializeUser(user: {
  id: number;
  email: string;
  username: string | null;
  aiCredits: number;
}) {
  return {
    id: user.id,
    email: user.email,
    username: user.username ?? undefined,
    aiCredits: user.aiCredits,
  };
}

// resolvePlanOverride() ã‚’å‰Šé™¤
// withPlanOverride() ã‚’å‰Šé™¤
```

- [x] `plan` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å‚ç…§ã‚’ã™ã¹ã¦å‰Šé™¤
- [x] `resolvePlanOverride()` é–¢æ•°ã‚’å‰Šé™¤
- [x] `withPlanOverride()` é–¢æ•°ã‚’å‰Šé™¤
- [x] ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‹ã‚‰ `userPlan` ã‚’å‰Šé™¤ï¼ˆ`types/express-session.d.ts`ï¼‰
- [x] ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆä¿®æ­£

### 3.6 ã‚»ãƒƒã‚·ãƒ§ãƒ³å‹å®šç¾©ã®ä¿®æ­£

#### âœ… ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ: `apps/server/src/types/express-session.d.ts`

```typescript
// ä¿®æ­£å‰
declare module 'express-session' {
  interface SessionData {
    userId?: number;
    userPlan?: UserPlan;
    aiCredits?: number;
  }
}

// ä¿®æ­£å¾Œ
declare module 'express-session' {
  interface SessionData {
    userId?: number;
    aiCredits?: number;
    // userPlan ã‚’å‰Šé™¤
  }
}
```

- [x] `userPlan` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’å‰Šé™¤
- [x] `UserPlan` import ã‚’å‰Šé™¤

---

## 4. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIè¨­è¨ˆï¼ˆç´¹ä»‹åˆ¶åº¦ï¼‰

### 4.1 æ‹›å¾…ãƒªãƒ³ã‚¯ç”ŸæˆAPI

#### âœ… ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ: `POST /api/referral/invite-link`

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**:
```json
{
  "timezone": "Asia/Tokyo"
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
```json
{
  "inviteLink": "meallog://invite?code=A3K9Px",
  "webLink": "https://meal-log.app/invite?code=A3K9Px",
  "code": "A3K9Px",
  "message": "å‹ã ã¡1äººã§30æ—¥å»¶é•·"
}
```

**å®Ÿè£…ã‚¿ã‚¹ã‚¯**:
- [x] `/api/referral/invite-link` ãƒ«ãƒ¼ãƒˆä½œæˆ
- [x] ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ã«ä¸€æ„ã®çŸ­ç¸®ã‚³ãƒ¼ãƒ‰ç”Ÿæˆï¼ˆ6æ–‡å­—ã€A-Za-z0-9ï¼‰
- [x] `ReferralInviteLink` ãƒ†ãƒ¼ãƒ–ãƒ«ã«ä¿å­˜ï¼ˆæ—¢å­˜ãªã‚‰å†åˆ©ç”¨ï¼‰
- [x] ãƒ‡ã‚£ãƒ¼ãƒ—ãƒªãƒ³ã‚¯ + Webãƒ©ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒšãƒ¼ã‚¸ä¸¡æ–¹ã®URLã‚’è¿”å´
- [x] èªè¨¼å¿…é ˆï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯ï¼‰
- [x] referral-service.tså®Ÿè£…å®Œäº†
- [x] CIé€šé

### 4.2 æ‹›å¾…ã‚³ãƒ¼ãƒ‰æ¤œè¨¼ãƒ»ç´ä»˜ã‘API

#### âœ… ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ: `POST /api/referral/claim`

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ**:
```json
{
  "code": "A3K9Px",
  "timezone": "Asia/Tokyo"
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
```json
{
  "success": true,
  "premiumDays": 14,
  "premiumUntil": "2025-11-06T23:59:59Z",
  "referrerUsername": "TaroYamada"
}
```

**å®Ÿè£…ã‚¿ã‚¹ã‚¯**:
- [x] `/api/referral/claim` ãƒ«ãƒ¼ãƒˆä½œæˆ
- [x] æ‹›å¾…ã‚³ãƒ¼ãƒ‰ã®å­˜åœ¨ç¢ºèª
- [x] é‡è¤‡é˜²æ­¢ãƒã‚§ãƒƒã‚¯ï¼ˆåŒä¸€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¤‡æ•°å›ä½¿ç”¨ä¸å¯ï¼‰
- [x] è‡ªå·±ç´¹ä»‹é˜²æ­¢ï¼ˆreferrerUserId â‰  referredUserIdï¼‰
- [x] ãƒ‡ãƒã‚¤ã‚¹æŒ‡ç´‹ç”Ÿæˆãƒ»è¨˜éŒ²ï¼ˆSHA256ãƒãƒƒã‚·ãƒ¥ï¼‰
- [x] `Referral` ãƒ¬ã‚³ãƒ¼ãƒ‰ä½œæˆï¼ˆstatus: PENDINGï¼‰
- [x] **å‹ã ã¡ã«14æ—¥ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ä»˜ä¸**ï¼ˆPremiumGrantä½œæˆï¼‰
- [x] `ReferralInviteLink` ã® `signupCount` ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ
- [x] èªè¨¼å¿…é ˆ
- [x] referral-service.tså®Ÿè£…å®Œäº†
- [x] CIé€šé

### 4.3 ãƒ—ãƒ¬ãƒŸã‚¢ãƒ çŠ¶æ…‹å–å¾—API

#### âœ… ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ: `GET /api/user/premium-status`

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
```json
{
  "isPremium": true,
  "source": "REFERRAL_FRIEND",
  "daysRemaining": 12,
  "expiresAt": "2025-11-06T23:59:59Z",
  "grants": [
    {
      "source": "REFERRAL_FRIEND",
      "days": 14,
      "startDate": "2025-10-23T00:00:00Z",
      "endDate": "2025-11-06T23:59:59Z"
    }
  ]
}
```

**å®Ÿè£…ã‚¿ã‚¹ã‚¯**:
- [x] `/api/user/premium-status` ãƒ«ãƒ¼ãƒˆä½œæˆ
- [x] `getPremiumStatus()` ã‚’ä½¿ã£ã¦ãƒ—ãƒ¬ãƒŸã‚¢ãƒ çŠ¶æ…‹å–å¾—
- [x] ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¨ `PremiumGrant` ã‚’å–å¾—
- [x] èªè¨¼å¿…é ˆ
- [x] routes/account.tså®Ÿè£…å®Œäº†
- [x] CIé€šé

### 4.4 ç´¹ä»‹çŠ¶æ³å–å¾—API

#### âœ… ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ: `GET /api/referral/my-status`

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹**:
```json
{
  "inviteCode": "A3K9Px",
  "inviteLink": "meallog://invite?code=A3K9Px",
  "stats": {
    "totalReferred": 5,
    "completedReferred": 2,
    "pendingReferred": 3,
    "totalPremiumDaysEarned": 60
  },
  "recentReferrals": [
    {
      "friendUsername": "HanakoSato",
      "status": "COMPLETED",
      "consecutiveDays": 3,
      "createdAt": "2025-10-20T10:00:00Z",
      "completedAt": "2025-10-23T10:00:00Z"
    }
  ]
}
```

**å®Ÿè£…ã‚¿ã‚¹ã‚¯**:
- [x] `/api/referral/my-status` ãƒ«ãƒ¼ãƒˆä½œæˆ
- [x] ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ‹›å¾…ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
- [x] ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¨ `Referral` ã‚’å–å¾—ï¼ˆreferrerUserIdï¼‰
- [x] çµ±è¨ˆæƒ…å ±ã‚’è¨ˆç®—ï¼ˆtotal, completed, pending, days earnedï¼‰
- [x] æœ€æ–°5ä»¶ã®ç´¹ä»‹çŠ¶æ³ã‚’è¿”å´
- [x] èªè¨¼å¿…é ˆ
- [x] referral-service.tså®Ÿè£…å®Œäº†
- [x] CIé€šé

### 4.5 3æ—¥é€£ç¶šãƒ­ã‚°ãƒã‚§ãƒƒã‚¯ã‚¸ãƒ§ãƒ–

#### âœ… ãƒãƒƒãƒã‚¸ãƒ§ãƒ–: `check-referral-completion`

**å®Ÿè¡Œé »åº¦**: 1æ—¥1å›ï¼ˆåˆå‰3æ™‚ JSTï¼‰

**å‡¦ç†å†…å®¹**:
1. `Referral` ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ `status = PENDING` ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å…¨å–å¾—
2. å„ãƒ¬ã‚³ãƒ¼ãƒ‰ã«ã¤ã„ã¦ã€è¢«ç´¹ä»‹è€…ï¼ˆreferredUserï¼‰ã® `MealLog` ã‚’ç¢ºèª
3. ç›´è¿‘3æ—¥é–“ã«é€£ç¶šã—ã¦ãƒ­ã‚°ãŒã‚ã‚‹ã‹åˆ¤å®š
4. é”æˆã—ã¦ã„ã‚Œã°:
   - `Referral.status` ã‚’ `COMPLETED` ã«æ›´æ–°
   - **ç´¹ä»‹è€…ã«30æ—¥ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ä»˜ä¸**ï¼ˆ`grantPremiumDays()` ä½¿ç”¨ï¼‰
   - `Referral.referrerPremiumGranted` ã‚’ true ã«è¨­å®š
5. 30æ—¥çµŒéã—ã¦ã‚‚æœªé”æˆãªã‚‰:
   - `Referral.status` ã‚’ `EXPIRED` ã«æ›´æ–°

**å®Ÿè£…ã‚¿ã‚¹ã‚¯**:
- [x] `apps/server/src/jobs/check-referral-completion.ts` ä½œæˆ
- [x] 3æ—¥é€£ç¶šãƒ­ã‚°åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯å®Ÿè£…ï¼ˆreferral-service.tså†…ï¼‰
- [x] PremiumGrantä½œæˆã§30æ—¥ä»˜ä¸
- [x] 30æ—¥æœŸé™åˆ‡ã‚Œãƒã‚§ãƒƒã‚¯å®Ÿè£…ï¼ˆexpireOldReferralsï¼‰
- [x] index.tsã«ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°è¿½åŠ ï¼ˆæ¯æ—¥3æ™‚JSTå®Ÿè¡Œï¼‰
- [x] ãƒ­ã‚°å‡ºåŠ›ï¼ˆPinoï¼‰
- [x] CIé€šé

---

## 5. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼ˆMobileï¼‰å®Ÿè£…

### 5.1 æ‹›å¾…ãƒªãƒ³ã‚¯ç”Ÿæˆãƒ»å…±æœ‰æ©Ÿèƒ½

#### âœ… å®Ÿè£…ç®‡æ‰€: `apps/mobile/app/(tabs)/settings.tsx`

**å¤‰æ›´å†…å®¹**:
- [x] `handleInvite` é–¢æ•°ã‚’å®Ÿè£…
  - API `/api/referral/invite-link` ã‚’å‘¼ã³å‡ºã—
  - æ‹›å¾…ãƒªãƒ³ã‚¯ã‚’å–å¾—
  - `Share.share()` ã§å…±æœ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¡¨ç¤º
    - ã‚¿ã‚¤ãƒˆãƒ«: ã€ŒMeal Logã‚’ä¸€ç·’ã«ä½¿ã„ã¾ã›ã‚“ã‹ï¼Ÿã€
    - ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸: ã€Œç´¹ä»‹ãƒªãƒ³ã‚¯ã‹ã‚‰ç™»éŒ²ã™ã‚‹ã¨14æ—¥é–“ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ç„¡æ–™ï¼å‹ã ã¡ã‚’ç´¹ä»‹ã™ã‚‹ã¨30æ—¥å»¶é•·ã‚‚ï¼ {inviteLink}ã€
- [ ] å…±æœ‰ãƒãƒ£ãƒãƒ«ãƒœã‚¿ãƒ³è¿½åŠ ï¼ˆ**LINEã‚’ãƒ—ãƒ©ã‚¤ãƒãƒª**ã€ä»–ã‚’ã‚»ã‚«ãƒ³ãƒ€ãƒªï¼‰ï¼ˆå„ªå…ˆåº¦: ä½ã€å°†æ¥å®Ÿè£…ï¼‰
  - **LINE**: `line://msg/text/{message}` - **å¤§ããç›®ç«‹ã¤ãƒœã‚¿ãƒ³**
  - Instagram: DMä¸å¯ã€ã‚¹ãƒˆãƒ¼ãƒªãƒ¼æŠ•ç¨¿ã®ã¿ï¼ˆ`instagram://story-camera`ï¼‰- å°ã•ã‚ãƒœã‚¿ãƒ³
  - X: `twitter://post?message={message}` - å°ã•ã‚ãƒœã‚¿ãƒ³
  - WhatsApp: `whatsapp://send?text={message}` - å°ã•ã‚ãƒœã‚¿ãƒ³
- [x] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼ˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã€APIã‚¨ãƒ©ãƒ¼ï¼‰
- [x] ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹è¡¨ç¤º

#### âœ… ç¿»è¨³è¿½åŠ : `apps/mobile/src/i18n/index.ts`

- [x] `referral.share.title`: ã€ŒMeal Logã‚’ä¸€ç·’ã«ä½¿ã„ã¾ã›ã‚“ã‹ï¼Ÿã€
- [x] `referral.share.message`: ã€Œã“ã®ãƒªãƒ³ã‚¯ã‹ã‚‰ç™»éŒ²ã™ã‚‹ã¨14æ—¥é–“ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ç„¡æ–™ï¼å‹ã ã¡ã‚’ç´¹ä»‹ã™ã‚‹ã¨30æ—¥å»¶é•·ã‚‚ï¼ {{link}}ã€
- [x] `referral.invite.rewardText`: ã€Œå‹ã ã¡1äººã§30æ—¥å»¶é•·ã€
- [x] `referral.friend.rewardText`: ã€Œç´¹ä»‹ãªã‚‰14æ—¥é–“ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ç„¡æ–™ã€
- [x] `referral.error.loadFailed`: ã€Œæ‹›å¾…ãƒªãƒ³ã‚¯ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€
- [x] `referral.error.shareFailed`: ã€Œå…±æœ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€
- [x] ç´¹ä»‹çŠ¶æ³ç”»é¢ç”¨ã®ç¿»è¨³ã‚‚è¿½åŠ 
- [x] è‹±èªç‰ˆã‚‚è¿½åŠ 

### 5.2 ãƒ‡ã‚£ãƒ¼ãƒ—ãƒªãƒ³ã‚¯å—ä¿¡ãƒ»å‡¦ç†

#### âœ… å®Ÿè£…ç®‡æ‰€: `apps/mobile/app/_layout.tsx`

**å¤‰æ›´å†…å®¹**:
- [ ] `expo-linking` ã® `useURL()` ã§ãƒ‡ã‚£ãƒ¼ãƒ—ãƒªãƒ³ã‚¯ã‚’ç›£è¦–
- [ ] `meallog://invite?code={code}` ã‚’æ¤œå‡º
- [ ] ãƒ­ã‚°ã‚¤ãƒ³æ¸ˆã¿ã®å ´åˆ:
  - API `/api/referral/claim` ã‚’å‘¼ã³å‡ºã—
  - æˆåŠŸæ™‚: ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤ºã€Œ14æ—¥é–“ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ã‚’ç²å¾—ã—ã¾ã—ãŸï¼ã€
  - å¤±æ•—æ™‚: ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
- [ ] æœªãƒ­ã‚°ã‚¤ãƒ³ã®å ´åˆ:
  - æ‹›å¾…ã‚³ãƒ¼ãƒ‰ã‚’ä¸€æ™‚ä¿å­˜ï¼ˆAsyncStorage: `@referral_code`ï¼‰
  - ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã«é·ç§»
  - ãƒ­ã‚°ã‚¤ãƒ³å¾Œã«è‡ªå‹•ã§ `/api/referral/claim` ã‚’å®Ÿè¡Œ

**å®Ÿè£…ã‚¿ã‚¹ã‚¯**:
- [ ] `apps/mobile/src/hooks/useReferralDeepLink.ts` ä½œæˆ
- [ ] `_layout.tsx` ã«çµ±åˆ
- [ ] AsyncStorageã§ã‚³ãƒ¼ãƒ‰ä¸€æ™‚ä¿å­˜
- [ ] ãƒ­ã‚°ã‚¤ãƒ³å¾Œã®è‡ªå‹•claimå®Ÿè£…
- [ ] ãƒˆãƒ¼ã‚¹ãƒˆé€šçŸ¥å®Ÿè£…

### 5.3 ç´¹ä»‹çŠ¶æ³ç”»é¢

#### âœ… æ–°è¦ç”»é¢: `apps/mobile/app/referral-status.tsx`

**UIæ§‹æˆ**:
1. ãƒ˜ãƒƒãƒ€ãƒ¼: ã€Œç´¹ä»‹ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã€
2. æ‹›å¾…ã‚«ãƒ¼ãƒ‰:
   - æ‹›å¾…ã‚³ãƒ¼ãƒ‰è¡¨ç¤º
   - ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³
   - å…±æœ‰ãƒœã‚¿ãƒ³
3. çµ±è¨ˆã‚«ãƒ¼ãƒ‰:
   - ç´¹ä»‹äººæ•°ï¼ˆåˆè¨ˆ/é”æˆ/å¾…æ©Ÿä¸­ï¼‰
   - ç²å¾—ãƒ—ãƒ¬ãƒŸã‚¢ãƒ æ—¥æ•°
4. ç´¹ä»‹ãƒªã‚¹ãƒˆ:
   - å‹ã ã¡ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åï¼ˆåŒ¿ååŒ–: "User_1234"ï¼‰
   - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆé”æˆ/å¾…æ©Ÿä¸­/æœŸé™åˆ‡ã‚Œï¼‰
   - é€£ç¶šæ—¥æ•°ãƒãƒƒã‚¸ï¼ˆ"2/3æ—¥" ãªã©ï¼‰
   - é”æˆæ—¥æ™‚

**å®Ÿè£…ã‚¿ã‚¹ã‚¯**:
- [ ] `apps/mobile/app/referral-status.tsx` ä½œæˆ
- [ ] API `/api/referral/my-status` ã¨çµ±åˆ
- [ ] ãƒªã‚¹ãƒˆè¡¨ç¤ºï¼ˆFlatListï¼‰
- [ ] ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½å®Ÿè£…ï¼ˆClipboard APIï¼‰
- [ ] å…±æœ‰æ©Ÿèƒ½å®Ÿè£…ï¼ˆShare APIï¼‰
- [ ] è¨­å®šç”»é¢ã‹ã‚‰ã®ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³è¿½åŠ 

### 5.4 ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒãƒƒã‚¸ãƒ»æ®‹æ—¥æ•°è¡¨ç¤º

#### âœ… å®Ÿè£…ç®‡æ‰€: ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã€è¨­å®šç”»é¢

**å¤‰æ›´å†…å®¹**:
- [ ] API `/api/user/premium-status` ã‚’å‘¼ã³å‡ºã—
- [ ] ãƒ—ãƒ¬ãƒŸã‚¢ãƒ çŠ¶æ…‹ã‚’ Zustand store ã«ä¿å­˜
- [ ] ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒãƒƒã‚¸è¡¨ç¤º
  - ã‚¢ã‚¤ã‚³ãƒ³: â­ï¸ or ğŸ‘‘
  - ãƒ†ã‚­ã‚¹ãƒˆ: ã€Œãƒ—ãƒ¬ãƒŸã‚¢ãƒ ä¼šå“¡ï¼ˆæ®‹ã‚Š12æ—¥ï¼‰ã€
- [ ] è¨­å®šç”»é¢ã®ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚«ãƒ¼ãƒ‰ã«ãƒãƒƒã‚¸è¿½åŠ 
- [ ] ãƒ—ãƒ¬ãƒŸã‚¢ãƒ é™å®šæ©Ÿèƒ½ã«éµã‚¢ã‚¤ã‚³ãƒ³è¡¨ç¤ºï¼ˆç„¡æ–™ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰

**å®Ÿè£…ã‚¿ã‚¹ã‚¯**:
- [ ] `apps/mobile/src/store/premium.ts` ä½œæˆï¼ˆZustandï¼‰
- [ ] `/api/user/premium-status` çµ±åˆ
- [ ] ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ãƒãƒƒã‚¸è¡¨ç¤º
- [ ] è¨­å®šç”»é¢ã«ãƒãƒƒã‚¸è¡¨ç¤º
- [ ] ãƒ—ãƒ¬ãƒŸã‚¢ãƒ é™å®šæ©Ÿèƒ½ã®ãƒšã‚¤ã‚¦ã‚©ãƒ¼ãƒ«å®Ÿè£…

---

## 6. ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ç‰¹å…¸å®Ÿè£…

### 6.1 æœˆé–“ã‚«ãƒ­ãƒªãƒ¼å·®åˆ†è¡¨ç¤ºï¼ˆæ—¢å­˜æ©Ÿèƒ½ã®åˆ¶é™è¿½åŠ ï¼‰

- [x] æ—¢ã«å®Ÿè£…æ¸ˆã¿ï¼ˆ`dashboard.tsx`ï¼‰
- [ ] `isPremium()` ã‚’ä½¿ã£ã¦ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ä¼šå“¡ã®ã¿è¡¨ç¤º
- [ ] ç„¡æ–™ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯éµã‚¢ã‚¤ã‚³ãƒ³ + ã€Œãƒ—ãƒ¬ãƒŸã‚¢ãƒ é™å®šã€è¡¨ç¤º
- [ ] ãƒšã‚¤ã‚¦ã‚©ãƒ¼ãƒ«ã‚¿ãƒƒãƒ—æ™‚ã«ç´¹ä»‹ãƒ—ãƒ­ã‚°ãƒ©ãƒ ç”»é¢ã¸èª˜å°

### 6.2 AIä½¿ç”¨åˆ¶é™ç·©å’Œ

- [x] æ—¢ã«å®Ÿè£…æ¸ˆã¿ï¼ˆ`ai-usage-service.ts` ã§å¯¾å¿œï¼‰
- [ ] ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ¦ãƒ¼ã‚¶ãƒ¼: 1æ—¥20å›
- [ ] ç„¡æ–™ãƒ¦ãƒ¼ã‚¶ãƒ¼: 1æ—¥3å›

### 6.3 å±¥æ­´90æ—¥ä¿å­˜ï¼ˆæ–°æ©Ÿèƒ½ãƒ»ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ç‰¹å…¸ï¼‰

#### âœ… å®Ÿè£…å†…å®¹

**ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰**:
- [x] `log-cleanup.ts` ã§å¯¾å¿œæ¸ˆã¿
- [ ] ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒ¦ãƒ¼ã‚¶ãƒ¼: 90æ—¥ä¿å­˜
- [ ] ç„¡æ–™ãƒ¦ãƒ¼ã‚¶ãƒ¼: 30æ—¥ä¿å­˜

**ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰**:
- [ ] å±¥æ­´ç”»é¢ã«æœŸé–“é¸æŠè¿½åŠ ï¼ˆã€Œ1ã‹æœˆã€ã€Œ3ã‹æœˆã€ï¼‰
- [ ] ç„¡æ–™ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯ã€Œ3ã‹æœˆã€ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’éè¡¨ç¤º
- [ ] ãƒ—ãƒ¬ãƒŸã‚¢ãƒ èª˜å°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºï¼ˆã€Œ90æ—¥å±¥æ­´ã‚’è¦‹ã‚‹ã«ã¯å‹ã ã¡ã‚’æ‹›å¾…ã—ã¦ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ã¸ï¼ã€ï¼‰
- [ ] èª˜å°ãƒœã‚¿ãƒ³ã‚¿ãƒƒãƒ—æ™‚ã«ç´¹ä»‹ãƒ—ãƒ­ã‚°ãƒ©ãƒ ç”»é¢ã¸é·ç§»

---

## 7. ä¸æ­£æ¤œçŸ¥ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### 7.1 é‡è¤‡é˜²æ­¢

#### âœ… ãƒã‚§ãƒƒã‚¯é …ç›®

- [ ] ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹é‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼ˆæ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼æ¤œå‡ºï¼‰
- [ ] åŒä¸€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¤‡æ•°ã®æ‹›å¾…ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã§ããªã„ã‚ˆã†ã«ã™ã‚‹
  - `Referral.referredUserId` ã¯ UNIQUE åˆ¶ç´„
- [ ] è‡ªå·±ç´¹ä»‹é˜²æ­¢ï¼ˆreferrerUserId â‰  referredUserIdï¼‰
- [ ] IPã‚¢ãƒ‰ãƒ¬ã‚¹ + User-Agentã®ãƒãƒƒã‚·ãƒ¥ã‚’è¨˜éŒ²ï¼ˆç°¡æ˜“ãƒ‡ãƒã‚¤ã‚¹æŒ‡ç´‹ï¼‰
  - `Referral` ãƒ†ãƒ¼ãƒ–ãƒ«ã« `deviceFingerprint` ã‚«ãƒ©ãƒ ä½¿ç”¨
  - åŒä¸€fingerprintã§è¤‡æ•°ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆã‚’æ¤œçŸ¥
- [ ] çŸ­æœŸé–“ã§ã®å¤§é‡ç´¹ä»‹ã‚’æ¤œçŸ¥ï¼ˆ1æ™‚é–“ã«10äººä»¥ä¸Š = ç–‘ã‚ã—ã„ï¼‰
  - ç®¡ç†è€…é€šçŸ¥ï¼ˆãƒ¡ãƒ¼ãƒ« or Slackï¼‰

**å®Ÿè£…ã‚¿ã‚¹ã‚¯**:
- [ ] `/api/referral/claim` ã«é‡è¤‡ãƒã‚§ãƒƒã‚¯ãƒ­ã‚¸ãƒƒã‚¯è¿½åŠ 
- [ ] IPã‚¢ãƒ‰ãƒ¬ã‚¹å–å¾—ï¼ˆ`req.ip`ï¼‰
- [ ] User-Agentå–å¾—ï¼ˆ`req.headers['user-agent']`ï¼‰
- [ ] ãƒ‡ãƒã‚¤ã‚¹æŒ‡ç´‹ç”Ÿæˆï¼ˆSHA256ãƒãƒƒã‚·ãƒ¥ï¼‰
- [ ] å¤§é‡ç´¹ä»‹æ¤œçŸ¥ã‚¢ãƒ©ãƒ¼ãƒˆå®Ÿè£…

### 7.2 ä¸æ­£ãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œçŸ¥

#### âœ… ç›£è¦–é …ç›®

- [ ] ç™»éŒ²å¾Œã™ãã«å‰Šé™¤ã•ã‚Œã‚‹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆï¼ˆ1é€±é–“ä»¥å†…ã«å‰Šé™¤ = ç–‘ã‚ã—ã„ï¼‰
- [ ] 3æ—¥é€£ç¶šãƒ­ã‚°ãŒã™ã¹ã¦åŒä¸€å†…å®¹ï¼ˆã‚³ãƒ”ãƒšç–‘æƒ‘ï¼‰
- [ ] ç™»éŒ²å¾Œã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ãŒç•°å¸¸ã«ä½ã„ï¼ˆ1é€±é–“ã§1å›ã®ã¿ï¼‰
- [ ] ãƒ—ãƒ¬ãƒŸã‚¢ãƒ æœŸé–“çµ‚äº†ç›´å‰ã«å¤§é‡ç´¹ä»‹ï¼ˆé§†ã‘è¾¼ã¿ç´¹ä»‹ï¼‰

**å®Ÿè£…ã‚¿ã‚¹ã‚¯**:
- [ ] ä¸æ­£æ¤œçŸ¥ã‚¸ãƒ§ãƒ–ä½œæˆï¼ˆ`detect-referral-fraud.ts`ï¼‰
- [ ] ç–‘ã‚ã—ã„ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ `Referral.status = FRAUD` ã«æ›´æ–°
- [ ] ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ç–‘ã‚ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆè¡¨ç¤ºï¼ˆå°†æ¥å®Ÿè£…ï¼‰

---

## 8. Analytics & KPIè¨ˆæ¸¬

### 8.1 ã‚¤ãƒ™ãƒ³ãƒˆãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°

#### âœ… å®Ÿè£…ã‚¿ã‚¹ã‚¯

- [ ] `referral.invite_link_generated`: æ‹›å¾…ãƒªãƒ³ã‚¯ç”Ÿæˆ
- [ ] `referral.invite_link_shared`: å…±æœ‰ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ï¼ˆãƒãƒ£ãƒãƒ«è¨˜éŒ²ï¼‰
- [ ] `referral.invite_link_clicked`: æ‹›å¾…ãƒªãƒ³ã‚¯ã‚¯ãƒªãƒƒã‚¯
- [ ] `referral.signup_via_referral`: ç´¹ä»‹çµŒç”±ã§ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—
- [ ] `referral.premium_claimed_friend`: å‹ã ã¡ãŒãƒ—ãƒ¬ãƒŸã‚¢ãƒ ç²å¾—
- [ ] `referral.premium_claimed_referrer`: ç´¹ä»‹è€…ãŒãƒ—ãƒ¬ãƒŸã‚¢ãƒ ç²å¾—
- [ ] `referral.conversion_to_paid`: ç´¹ä»‹çµŒç”±ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèª²é‡‘

**å®Ÿè£…ç®‡æ‰€**:
- [ ] `apps/mobile/src/analytics/events.ts` ã«ã‚¤ãƒ™ãƒ³ãƒˆå®šç¾©è¿½åŠ 
- [ ] å„APIãƒ»ç”»é¢ã§ `trackEvent()` å‘¼ã³å‡ºã—

### 8.2 KPIãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼ˆç®¡ç†è€…ç”¨ï¼‰

#### âœ… è¨ˆæ¸¬æŒ‡æ¨™

- [ ] Kä¿‚æ•°ï¼ˆ1ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚ãŸã‚Šç´¹ä»‹äººæ•°ï¼‰
- [ ] ç´¹ä»‹çµŒç”±ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—æ•°ï¼ˆæ—¥æ¬¡/é€±æ¬¡/æœˆæ¬¡ï¼‰
- [ ] 3æ—¥é€£ç¶šé”æˆç‡ï¼ˆCOMPLETED / TOTALï¼‰
- [ ] 30æ—¥ä»¥å†…æœ‰æ–™åŒ–ç‡ï¼ˆç´¹ä»‹çµŒç”± vs è‡ªç„¶æµå…¥ï¼‰
- [ ] ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ä»˜ä¸ã‚³ã‚¹ãƒˆï¼ˆä»˜ä¸æ—¥æ•° Ã— äººæ•°ï¼‰
- [ ] ä¸æ­£æ¤œçŸ¥æ•°

**å®Ÿè£…ã‚¿ã‚¹ã‚¯**:
- [ ] ç®¡ç†è€…ç”¨APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä½œæˆï¼ˆ`/admin/referral/stats`ï¼‰
- [ ] SQLé›†è¨ˆã‚¯ã‚¨ãƒªå®Ÿè£…
- [ ] ç°¡æ˜“ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰å®Ÿè£…ï¼ˆå°†æ¥: Metabase or Retoolçµ±åˆï¼‰

---

## 9. ãƒ†ã‚¹ãƒˆè¨ˆç”»

### 9.1 ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ

- [ ] `PremiumService.isPremium()` ãƒ†ã‚¹ãƒˆ
- [ ] `PremiumService.grantPremiumDays()` ãƒ†ã‚¹ãƒˆ
- [ ] `ReferralService.createInviteLink()` ãƒ†ã‚¹ãƒˆ
- [ ] `ReferralService.claimReferral()` ãƒ†ã‚¹ãƒˆï¼ˆé‡è¤‡é˜²æ­¢ï¼‰
- [ ] `ReferralService.checkConsecutiveDays()` ãƒ†ã‚¹ãƒˆï¼ˆ3æ—¥é€£ç¶šåˆ¤å®šï¼‰
- [ ] ãƒ‡ãƒã‚¤ã‚¹æŒ‡ç´‹ç”Ÿæˆãƒ†ã‚¹ãƒˆ
- [ ] ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ãƒ†ã‚¹ãƒˆ

### 9.2 çµ±åˆãƒ†ã‚¹ãƒˆ

- [ ] ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰: æ‹›å¾…ãƒªãƒ³ã‚¯ç”Ÿæˆ â†’ å‹ã ã¡ç™»éŒ² â†’ ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ä»˜ä¸
- [ ] ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰: 3æ—¥é€£ç¶šãƒ­ã‚° â†’ ç´¹ä»‹è€…ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ä»˜ä¸
- [ ] é‡è¤‡é˜²æ­¢: åŒä¸€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¤‡æ•°å›ä½¿ç”¨ã§ããªã„ã“ã¨ã‚’ç¢ºèª
- [ ] è‡ªå·±ç´¹ä»‹é˜²æ­¢: è‡ªåˆ†è‡ªèº«ã‚’ç´¹ä»‹ã§ããªã„ã“ã¨ã‚’ç¢ºèª
- [ ] æœŸé™åˆ‡ã‚Œ: 30æ—¥çµŒéå¾Œã«EXPIREDã«ãªã‚‹ã“ã¨ã‚’ç¢ºèª
- [ ] ãƒ—ãƒ¬ãƒŸã‚¢ãƒ æœŸé–“çµ‚äº†å¾Œã®ãƒ­ã‚°å‰Šé™¤ãƒ†ã‚¹ãƒˆ
- [ ] ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å‰å¾Œã®ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒ†ã‚¹ãƒˆ

### 9.3 æ‰‹å‹•ãƒ†ã‚¹ãƒˆ

- [ ] iOSå®Ÿæ©Ÿã§ãƒ‡ã‚£ãƒ¼ãƒ—ãƒªãƒ³ã‚¯å‹•ä½œç¢ºèª
- [ ] å…±æœ‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼å‹•ä½œç¢ºèªï¼ˆLINE, X, WhatsAppï¼‰
- [ ] ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒãƒƒã‚¸è¡¨ç¤ºç¢ºèª
- [ ] ç´¹ä»‹çŠ¶æ³ç”»é¢ã®è¡¨ç¤ºç¢ºèª
- [ ] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ç¢ºèªï¼ˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã€ä¸æ­£ã‚³ãƒ¼ãƒ‰ï¼‰
- [ ] ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œå¾Œã®å‹•ä½œç¢ºèª

---

## 10. ãƒ‡ãƒ—ãƒ­ã‚¤è¨ˆç”»

### 10.1 Phase 0: ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æº–å‚™ï¼ˆ2æ—¥ï¼‰

**å®Ÿè£…ç¯„å›²**:
- ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆä½œæˆ
- ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
- æœ¬ç•ªãƒ‡ãƒ¼ã‚¿ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—è¨ˆç”»

**æ¨å®šå·¥æ•°**: 2æ—¥

**ãƒªãƒªãƒ¼ã‚¹åˆ¤å®šåŸºæº–**:
- [ ] ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒæ­£å¸¸ã«å‹•ä½œ
- [ ] ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã§ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ç¢ºèª
- [ ] ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †ã®ç¢ºèª

### 10.2 Phase 1: åŸºæœ¬æ©Ÿèƒ½ + ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œï¼ˆ10æ—¥ï¼‰

**å®Ÿè£…ç¯„å›²**:
- DBè¨­è¨ˆãƒ»ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
- PremiumService æ–°è¦ä½œæˆ
- æ—¢å­˜ã‚³ãƒ¼ãƒ‰ä¿®æ­£ï¼ˆai-usage, log-cleanup, iap, authï¼‰
- ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIï¼ˆæ‹›å¾…ãƒªãƒ³ã‚¯ç”Ÿæˆã€claimã€ãƒ—ãƒ¬ãƒŸã‚¢ãƒ çŠ¶æ…‹å–å¾—ï¼‰
- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼ˆæ‹›å¾…ãƒªãƒ³ã‚¯ç”Ÿæˆãƒ»å…±æœ‰ã€ãƒ‡ã‚£ãƒ¼ãƒ—ãƒªãƒ³ã‚¯å—ä¿¡ï¼‰
- 3æ—¥é€£ç¶šãƒã‚§ãƒƒã‚¯ã‚¸ãƒ§ãƒ–
- ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ãƒãƒƒã‚¸è¡¨ç¤º

**æ¨å®šå·¥æ•°**: 10æ—¥

**ãƒªãƒªãƒ¼ã‚¹åˆ¤å®šåŸºæº–**:
- [ ] å…¨ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆãƒ‘ã‚¹
- [ ] å…¨çµ±åˆãƒ†ã‚¹ãƒˆãƒ‘ã‚¹
- [ ] iOSå®Ÿæ©Ÿã§æ‰‹å‹•ãƒ†ã‚¹ãƒˆå®Œäº†
- [ ] ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã§E2Eãƒ†ã‚¹ãƒˆå®Œäº†
- [ ] ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œå¾Œã®å‹•ä½œç¢ºèªå®Œäº†

### 10.3 Phase 2: ä¸æ­£æ¤œçŸ¥ãƒ»Analyticsï¼ˆ3æ—¥ï¼‰

**å®Ÿè£…ç¯„å›²**:
- ä¸æ­£æ¤œçŸ¥ã‚¸ãƒ§ãƒ–
- IPã‚¢ãƒ‰ãƒ¬ã‚¹ãƒ»ãƒ‡ãƒã‚¤ã‚¹æŒ‡ç´‹è¨˜éŒ²
- Analyticsã‚¤ãƒ™ãƒ³ãƒˆãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°
- ç®¡ç†è€…ç”¨KPIãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰

**æ¨å®šå·¥æ•°**: 3æ—¥

**ãƒªãƒªãƒ¼ã‚¹åˆ¤å®šåŸºæº–**:
- [ ] ä¸æ­£æ¤œçŸ¥ã‚¸ãƒ§ãƒ–ãŒæ­£å¸¸å‹•ä½œ
- [ ] Analyticsã‚¤ãƒ™ãƒ³ãƒˆãŒè¨˜éŒ²ã•ã‚Œã¦ã„ã‚‹
- [ ] ç®¡ç†è€…ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§KPIç¢ºèªå¯èƒ½

### 10.4 Phase 3: Androidå¯¾å¿œãƒ»Universal Linksï¼ˆ4æ—¥ï¼‰

**å®Ÿè£…ç¯„å›²**:
- Androidç‰ˆãƒ‡ã‚£ãƒ¼ãƒ—ãƒªãƒ³ã‚¯å¯¾å¿œ
- Universal Linksè¨­å®šï¼ˆ`/.well-known/apple-app-site-association`ï¼‰
- æœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ™‚ã®ãƒ©ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒšãƒ¼ã‚¸ä½œæˆ
- ã‚¹ãƒˆã‚¢è‡ªå‹•é·ç§»å®Ÿè£…

**æ¨å®šå·¥æ•°**: 4æ—¥

**ãƒªãƒªãƒ¼ã‚¹åˆ¤å®šåŸºæº–**:
- [ ] iOSæœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ™‚ã«App Storeã«é·ç§»
- [ ] Androidæœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ™‚ã«Google Playã«é·ç§»
- [ ] ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¾Œã«æ‹›å¾…ã‚³ãƒ¼ãƒ‰ãŒè‡ªå‹•é©ç”¨

---

## 11. ãƒªã‚¹ã‚¯ç®¡ç†

### 11.1 é«˜ãƒªã‚¹ã‚¯é …ç›®

| ãƒªã‚¹ã‚¯ | å½±éŸ¿ | ç·©å’Œç­– | æ‹…å½“ |
|--------|------|--------|------|
| ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¤±æ•— | é«˜ | ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ç’°å¢ƒã§ãƒ†ã‚¹ãƒˆã€ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨ˆç”» | Backend |
| ä¸æ­£ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å¤§é‡ç™ºç”Ÿ | é«˜ | ãƒ‡ãƒã‚¤ã‚¹æŒ‡ç´‹ã€ç®¡ç†è€…é€šçŸ¥ã€æ‰‹å‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼ | Backend |
| ãƒ‡ã‚£ãƒ¼ãƒ—ãƒªãƒ³ã‚¯ãŒå‹•ä½œã—ãªã„ | ä¸­ | ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆæ‰‹å‹•ã‚³ãƒ¼ãƒ‰å…¥åŠ›ï¼‰ | Mobile |
| ãƒ—ãƒ¬ãƒŸã‚¢ãƒ æœŸé–“ã®è¨ˆç®—ãƒŸã‚¹ | é«˜ | ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆå¾¹åº•ã€æ‰‹å‹•æ¤œè¨¼ | Backend |
| iOSå¯©æŸ»ã§ç´¹ä»‹åˆ¶åº¦ãŒå´ä¸‹ | é«˜ | App Storeå¯©æŸ»ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ç¢ºèªï¼ˆ3.2.2ï¼‰ | PM |

### 11.2 ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨ˆç”»

- [ ] Phase 1ãƒªãƒªãƒ¼ã‚¹å¾Œã€1é€±é–“ã¯æ©Ÿèƒ½ãƒ•ãƒ©ã‚°ã§ON/OFFåˆ‡ã‚Šæ›¿ãˆå¯èƒ½ã«ã™ã‚‹
- [ ] ç·Šæ€¥æ™‚ã¯ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§æ‹›å¾…ã‚«ãƒ¼ãƒ‰ã‚’éè¡¨ç¤ºã«ã™ã‚‹
- [ ] ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¤±æ•—æ™‚ã¯ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒ
- [ ] DBãƒ†ãƒ¼ãƒ–ãƒ«ã¯æ®‹ã—ã€ãƒ­ã‚¸ãƒƒã‚¯ã®ã¿ç„¡åŠ¹åŒ–

---

## 12. æˆåŠŸæŒ‡æ¨™ãƒ»ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°

### 12.1 åˆæœŸç›®æ¨™ï¼ˆãƒªãƒªãƒ¼ã‚¹å¾Œ30æ—¥ï¼‰

- [ ] Kä¿‚æ•° â‰¥ **0.3**ï¼ˆåˆæœŸãƒ•ã‚§ãƒ¼ã‚ºï¼‰
- [ ] ç´¹ä»‹çµŒç”±ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—æ•° â‰¥ 100äºº
- [ ] 3æ—¥é€£ç¶šé”æˆç‡ â‰¥ 40%
- [ ] 30æ—¥ä»¥å†…æœ‰æ–™åŒ–ç‡ â‰¥ 10%ï¼ˆç´¹ä»‹çµŒç”±ï¼‰

### 12.2 ä¸­æœŸç›®æ¨™ï¼ˆãƒªãƒªãƒ¼ã‚¹å¾Œ90æ—¥ï¼‰

- [ ] Kä¿‚æ•° â‰¥ **0.5**ï¼ˆä¸»è¦KPIï¼‰
- [ ] ç´¹ä»‹çµŒç”±ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—æ•° â‰¥ 500äºº
- [ ] 3æ—¥é€£ç¶šé”æˆç‡ â‰¥ 50%
- [ ] 30æ—¥ä»¥å†…æœ‰æ–™åŒ–ç‡ â‰¥ 15%ï¼ˆç´¹ä»‹çµŒç”±ï¼‰
- [ ] ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ç¶™ç¶šç‡ï¼ˆç´¹ä»‹çµŒç”±ï¼‰ â‰¥ 30%ï¼ˆãƒ—ãƒ¬ãƒŸã‚¢ãƒ æœŸé–“çµ‚äº†å¾Œã«èª²é‡‘ï¼‰

### 12.3 ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š

- [ ] ä¸æ­£æ¤œçŸ¥æ•°ãŒ1æ—¥10ä»¶ã‚’è¶…ãˆãŸã‚‰Slacké€šçŸ¥
- [ ] 3æ—¥é€£ç¶šé”æˆç‡ãŒ20%ã‚’ä¸‹å›ã£ãŸã‚‰ã‚¢ãƒ©ãƒ¼ãƒˆï¼ˆè¨­è¨ˆè¦‹ç›´ã—ï¼‰
- [ ] Kä¿‚æ•°ãŒ0.2ã‚’ä¸‹å›ã£ãŸã‚‰ã‚¢ãƒ©ãƒ¼ãƒˆï¼ˆãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³å¼·åŒ–ï¼‰

---

## 13. æœªè§£æ±ºäº‹é …ãƒ»ä»Šå¾Œã®æ¤œè¨

- [ ] Androidç‰ˆã®å„ªå…ˆé †ä½ã‚’å†æ¤œè¨ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®è¦æœ›æ¬¡ç¬¬ï¼‰
- [ ] ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ç‰¹å…¸ã®è¿½åŠ æ¤œè¨ï¼ˆAIç¿»è¨³ç„¡åˆ¶é™ã€ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½ãªã©ï¼‰
- [ ] ç´¹ä»‹ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ©Ÿèƒ½ï¼ˆä¸Šä½10åã«ãƒœãƒ¼ãƒŠã‚¹ï¼‰
- [ ] æ³•å‹™ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆåˆ©ç”¨è¦ç´„ã«ç´¹ä»‹åˆ¶åº¦ã®è¨˜è¼‰è¿½åŠ ï¼‰
- [ ] LINEã§ã®å…±æœ‰ä½“é¨“ã‚’æœ€é©åŒ–ï¼ˆOGPç”»åƒã€ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ï¼‰

---

## 14. é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- `_docs/thinking/20251023_referral-program-review.md`: ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°è¦³ç‚¹ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼
- `_docs/thinking/20251023_referral-program-conflicts-analysis.md`: ç¾çŠ¶ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã¨ã®æ•´åˆæ€§èª¿æŸ»
- `_docs/features/20251023_referral-program-summary.md`: ç¢ºå®šä»•æ§˜ã‚µãƒãƒªãƒ¼
- `_docs/features/20251023_referral-program-implementation-plan.md`: æ—§å®Ÿè£…è¨ˆç”»æ›¸ï¼ˆv1ã€å‚è€ƒç”¨ï¼‰
- `_docs/specs/api-referral.md`: APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä»•æ§˜ï¼ˆä½œæˆäºˆå®šï¼‰
- `README.md`: ç’°å¢ƒæ§‹ç¯‰æ‰‹é †
- `Agent.md`: é–‹ç™ºãƒ—ãƒ­ãƒˆã‚³ãƒ«

---

**æœ€çµ‚æ›´æ–°**: 2025-10-23  
**æ¬¡å›ãƒ¬ãƒ“ãƒ¥ãƒ¼**: Phase 1å®Ÿè£…å®Œäº†å¾Œï¼ˆæ¨å®š11æœˆä¸Šæ—¬ï¼‰  
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: v2ï¼ˆæ¡ˆAæ¡ç”¨ç‰ˆï¼‰
