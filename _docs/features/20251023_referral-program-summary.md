# ç´¹ä»‹åˆ¶åº¦ - ç¢ºå®šä»•æ§˜ã‚µãƒãƒªãƒ¼

**æ›´æ–°æ—¥**: 2025-10-23  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: æœ€çµ‚ç¢ºå®šã€å®Ÿè£…æº–å‚™å®Œäº†  

---

## ğŸ“‹ ç¢ºå®šä»•æ§˜ï¼ˆæœ€çµ‚ç‰ˆï¼‰

### ãƒªãƒ¯ãƒ¼ãƒ‰è¨­è¨ˆ

| å¯¾è±¡ | æ¡ä»¶ | å ±é…¬ | å‚™è€ƒ |
|------|------|------|------|
| **å‹ã ã¡ï¼ˆè¢«ç´¹ä»‹è€…ï¼‰** | ç™»éŒ²å®Œäº†æ™‚ | **14æ—¥é–“**ãƒ—ãƒ¬ãƒŸã‚¢ãƒ  | å³æ™‚ä»˜ä¸ |
| **ç´¹ä»‹è€…** | å‹ã ã¡ãŒ3æ—¥é€£ç¶šãƒ­ã‚°é”æˆ | **30æ—¥é–“**ãƒ—ãƒ¬ãƒŸã‚¢ãƒ  | äººæ•°ç„¡åˆ¶é™ |

**è¡¨ç¾**: ã€Œå‹ã ã¡1äººã§30æ—¥å»¶é•·ã€ï¼ˆã€Œæœ€å¤§ã€ã¨ã„ã†æ›–æ˜§ãªè¡¨ç¾ã¯ä½¿ã‚ãªã„ï¼‰

### ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ç‰¹å…¸

1. **æœˆé–“ã‚«ãƒ­ãƒªãƒ¼å·®åˆ†è¡¨ç¤º**ï¼ˆæ—¢å­˜æ©Ÿèƒ½ã‚’ãƒ—ãƒ¬ãƒŸã‚¢ãƒ é™å®šåŒ–ï¼‰
2. **éå»90æ—¥ã®å±¥æ­´ä¿å­˜**ï¼ˆç„¡æ–™ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯30æ—¥ã®ã¿ï¼‰

### KPIç›®æ¨™

| æœŸé–“ | Kä¿‚æ•° | ç´¹ä»‹çµŒç”±ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ— | 3æ—¥é€£ç¶šé”æˆç‡ | 30æ—¥ä»¥å†…æœ‰æ–™åŒ–ç‡ |
|------|-------|---------------------|--------------|-----------------|
| **åˆæœŸï¼ˆã€œ30æ—¥ï¼‰** | â‰¥ 0.3 | â‰¥ 100äºº | â‰¥ 40% | â‰¥ 10% |
| **ä¸­æœŸï¼ˆã€œ90æ—¥ï¼‰** | **â‰¥ 0.5** | â‰¥ 500äºº | â‰¥ 50% | â‰¥ 15% |

### ã‚¹ã‚³ãƒ¼ãƒ—

- **Phase 1**: iOSå…ˆè¡Œã€åŸºæœ¬æ©Ÿèƒ½ï¼ˆã‚¢ãƒ—ãƒªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼é–“ï¼‰
- **Phase 2**: ä¸æ­£æ¤œçŸ¥å¼·åŒ–ã€Analyticsçµ±åˆ
- **Phase 3**: Androidå¯¾å¿œã€Universal Linkså¯¾å¿œ

---

## ğŸ¨ UI/UXè¨­è¨ˆ

### å…±æœ‰ãƒãƒ£ãƒãƒ«ã®å„ªå…ˆé †ä½

1. **LINEï¼ˆãƒ—ãƒ©ã‚¤ãƒãƒªï¼‰**: å¤§ããç›®ç«‹ã¤ãƒœã‚¿ãƒ³
2. Instagram / X / WhatsAppï¼ˆã‚»ã‚«ãƒ³ãƒ€ãƒªï¼‰: å°ã•ã‚ãƒœã‚¿ãƒ³

**ç†ç”±**: æ—¥æœ¬å¸‚å ´ã§ã¯LINEãŒåœ§å€’çš„ã«å¼·ã„ãŸã‚ã€æœ€å„ªå…ˆã§é…ç½®

### ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ

**æ—¥æœ¬èª**:
```
Meal Logã‚’ä¸€ç·’ã«ä½¿ã„ã¾ã›ã‚“ã‹ï¼Ÿ
ã“ã®ãƒªãƒ³ã‚¯ã‹ã‚‰ç™»éŒ²ã™ã‚‹ã¨14æ—¥é–“ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ç„¡æ–™ï¼
å‹ã ã¡ã‚’ç´¹ä»‹ã™ã‚‹ã¨30æ—¥å»¶é•·ã‚‚ï¼
{inviteLink}
```

**è‹±èª**:
```
Join me on Meal Log!
Sign up with this link to get 14 days of premium free!
Refer friends to earn 30 more days!
{inviteLink}
```

---

## ğŸ”§ æŠ€è¡“å®Ÿè£…ã®é‡è¦ãƒã‚¤ãƒ³ãƒˆ

### 1. ãƒ—ãƒ¬ãƒŸã‚¢ãƒ åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯

```typescript
// PremiumGrantService.ts
function isPremium(userId: number): boolean {
  const grants = await prisma.premiumGrant.findMany({
    where: { 
      userId, 
      endDate: { gte: new Date() } 
    },
    orderBy: { endDate: 'desc' }
  });
  return grants.length > 0;
}

function getPremiumUntil(userId: number): Date | null {
  const grants = await prisma.premiumGrant.findMany({
    where: { 
      userId, 
      endDate: { gte: new Date() } 
    },
    orderBy: { endDate: 'desc' }
  });
  return grants[0]?.endDate ?? null;
}
```

### 2. 3æ—¥é€£ç¶šãƒ­ã‚°åˆ¤å®š

```typescript
// ReferralService.ts
async function checkConsecutiveDays(userId: number): Promise<number> {
  const logs = await prisma.mealLog.findMany({
    where: { 
      userId,
      deletedAt: null,
      zeroFloored: false
    },
    orderBy: { createdAt: 'desc' },
    take: 50 // ç›´è¿‘50ä»¶ã§åˆ¤å®š
  });

  let consecutiveDays = 0;
  let lastDate: Date | null = null;

  for (const log of logs) {
    const logDate = DateTime.fromJSDate(log.createdAt).startOf('day');
    
    if (!lastDate) {
      lastDate = logDate;
      consecutiveDays = 1;
      continue;
    }

    const diff = lastDate.diff(logDate, 'days').days;
    
    if (diff === 1) {
      consecutiveDays++;
      lastDate = logDate;
      if (consecutiveDays >= 3) break;
    } else if (diff > 1) {
      break; // é€”åˆ‡ã‚ŒãŸ
    }
  }

  return consecutiveDays;
}
```

### 3. é‡è¤‡é˜²æ­¢ãƒ­ã‚¸ãƒƒã‚¯

```typescript
// ReferralService.ts
async function claimReferral(userId: number, code: string): Promise<void> {
  // 1. æ—¢ã«ç´¹ä»‹ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ç”¨æ¸ˆã¿ã‹ç¢ºèª
  const existingReferral = await prisma.referral.findUnique({
    where: { referredUserId: userId }
  });
  if (existingReferral) {
    throw new Error('æ—¢ã«æ‹›å¾…ã‚³ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™');
  }

  // 2. æ‹›å¾…ã‚³ãƒ¼ãƒ‰ã®å­˜åœ¨ç¢ºèª
  const inviteLink = await prisma.referralInviteLink.findUnique({
    where: { code }
  });
  if (!inviteLink) {
    throw new Error('ç„¡åŠ¹ãªæ‹›å¾…ã‚³ãƒ¼ãƒ‰ã§ã™');
  }

  // 3. è‡ªå·±ç´¹ä»‹é˜²æ­¢
  if (inviteLink.userId === userId) {
    throw new Error('è‡ªåˆ†è‡ªèº«ã‚’æ‹›å¾…ã™ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“');
  }

  // 4. ãƒ‡ãƒã‚¤ã‚¹æŒ‡ç´‹ãƒã‚§ãƒƒã‚¯ï¼ˆç°¡æ˜“ç‰ˆï¼‰
  const fingerprint = generateDeviceFingerprint(req);
  const recentReferrals = await prisma.referral.findMany({
    where: {
      deviceFingerprint: fingerprint,
      createdAt: { gte: DateTime.now().minus({ days: 7 }).toJSDate() }
    }
  });
  if (recentReferrals.length >= 3) {
    // ç–‘ã‚ã—ã„ãƒ‘ã‚¿ãƒ¼ãƒ³: åŒä¸€ãƒ‡ãƒã‚¤ã‚¹ã‹ã‚‰1é€±é–“ã§3å›ä»¥ä¸Š
    await notifyAdmin('Suspicious referral pattern detected', { userId, fingerprint });
  }

  // 5. Referralãƒ¬ã‚³ãƒ¼ãƒ‰ä½œæˆ + å‹ã ã¡ã«ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ä»˜ä¸
  // ...
}
```

---

## ğŸ“Š ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°è¨ˆç”»

### ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«è¡¨ç¤ºã™ã‚‹æŒ‡æ¨™

1. **Kä¿‚æ•°**: `ç´¹ä»‹äººæ•° / ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°`
2. **ç´¹ä»‹çµŒç”±ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—æ•°**: æ—¥æ¬¡/é€±æ¬¡/æœˆæ¬¡
3. **3æ—¥é€£ç¶šé”æˆç‡**: `COMPLETED / (COMPLETED + PENDING + EXPIRED)`
4. **30æ—¥ä»¥å†…æœ‰æ–™åŒ–ç‡**: ç´¹ä»‹çµŒç”±ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒ30æ—¥ä»¥å†…ã«èª²é‡‘ã—ãŸå‰²åˆ
5. **ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ç¶™ç¶šç‡**: ãƒ—ãƒ¬ãƒŸã‚¢ãƒ æœŸé–“çµ‚äº†å¾Œã«èª²é‡‘ã—ãŸå‰²åˆ
6. **ä¸æ­£æ¤œçŸ¥æ•°**: `FRAUD` ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®ä»¶æ•°

### ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š

| æ¡ä»¶ | ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ |
|------|-----------|
| ä¸æ­£æ¤œçŸ¥æ•° > 10ä»¶/æ—¥ | Slacké€šçŸ¥ |
| Kä¿‚æ•° < 0.2 | ã‚¢ãƒ©ãƒ¼ãƒˆï¼ˆãƒ—ãƒ­ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³å¼·åŒ–ï¼‰ |
| 3æ—¥é€£ç¶šé”æˆç‡ < 20% | ã‚¢ãƒ©ãƒ¼ãƒˆï¼ˆè¨­è¨ˆè¦‹ç›´ã—ï¼‰ |

---

## âœ… ãƒ¬ãƒ“ãƒ¥ãƒ¼æ™‚ã®å¤‰æ›´å±¥æ­´

| é …ç›® | åˆæœŸææ¡ˆ | æœ€çµ‚æ±ºå®š | ç†ç”± |
|------|---------|---------|------|
| ç´¹ä»‹è€…ãƒªãƒ¯ãƒ¼ãƒ‰ | 21æ—¥ | **30æ—¥** | ç´¹ä»‹ã‚¤ãƒ³ã‚»ãƒ³ãƒ†ã‚£ãƒ–ã‚’æœ€å¤§åŒ– |
| Kä¿‚æ•°ç›®æ¨™ | 1.0 | **0.5** | ç¾å®Ÿçš„ãªç›®æ¨™å€¤ã«èª¿æ•´ |
| ãƒªãƒ¯ãƒ¼ãƒ‰è¡¨ç¾ | ã€Œæœ€å¤§30æ—¥ã€ | **ã€Œå‹ã ã¡1äººã§30æ—¥å»¶é•·ã€** | æ˜ç¢ºã§èª¤è§£ã®ãªã„è¡¨ç¾ |
| ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ç‰¹å…¸ | æœˆé–“ã‚«ãƒ­ãƒªãƒ¼å·®åˆ†ã®ã¿ | **+ å±¥æ­´90æ—¥ä¿å­˜** | å·®åˆ¥åŒ–å¼·åŒ– |
| å…±æœ‰ãƒãƒ£ãƒãƒ« | ä¸¦åˆ— | **LINEã‚’ãƒ—ãƒ©ã‚¤ãƒãƒª** | æ—¥æœ¬å¸‚å ´ã®ç‰¹æ€§ã‚’è€ƒæ…® |

---

## ğŸ“ é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

- **ãƒ¬ãƒ“ãƒ¥ãƒ¼**: `_docs/thinking/20251023_referral-program-review.md`
- **å®Ÿè£…è¨ˆç”»æ›¸**: `_docs/features/20251023_referral-program-implementation-plan.md`
- **APIä»•æ§˜**: `_docs/specs/api-referral.md`ï¼ˆä½œæˆäºˆå®šï¼‰

---

**æœ€çµ‚ç¢ºèªæ—¥**: 2025-10-23  
**æ‰¿èªè€…**: ãƒ¦ãƒ¼ã‚¶ãƒ¼  
**å®Ÿè£…é–‹å§‹äºˆå®š**: 2025-10-24
