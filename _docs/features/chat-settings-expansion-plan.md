# Chat / Dashboard / Settings 拡張 実装計画

## 現状サマリ
- 食事ログ登録時に時間帯タグを自動付与しているが、サーバー時刻基準のためユーザーのローカル時間とずれる可能性がある。
- ダッシュボードは週表示が初期状態で、日表示や期間フィルターが未整備。
- 食事履歴に削除導線・期間フィルター・時間履歴などの管理機能が不足している。
- 設定画面にストア審査で必須となるプライバシーポリシーやアカウント削除等が存在せず、全体的な情報設計が不足している。

---

## フェーズ別ロードマップ

### Phase 0: 事前整理・仕様確定
- [x] タイムゾーンの扱い方針を確定（例: クライアント送信 → サーバー保存）。
- [x] 設定画面で表示するプライバシーポリシー/利用規約の文面とURLを準備し、法務確認を完了する。
- [x] アカウント削除時のデータ保持ポリシー（即時削除 or 猶予期間）を決定する。
- [x] 目標値・プロフィール情報の保存および将来的な活用方針を定義する。
- [x] 新機能で収集する分析イベント／ログ要件を確認する。

### Phase 1: サーバー基盤拡張
- [x] DBマイグレーション: `MealLogPeriodHistory` テーブル追加、既存スキーマへの関連を設定する。
- [x] 時間帯判定ロジックをユーザータイムゾーンに対応させ、`MealLogPeriodHistory` に初回履歴を記録する。
- [x] `processMealLog` で `timezone` パラメータを受け取り、レスポンス `meta` にも格納する。
- [x] MealLog更新API（PATCH）で時間帯更新履歴を保存する。
- [x] MealLog詳細APIのレスポンスに `time_history` を含める。

### Phase 2: 食事履歴API強化
- [x] `/api/logs` に期間フィルター（today/week/twoWeeks/threeWeeks/month）とタイムゾーン処理を追加する。
- [x] `/api/log/:id` DELETE がソフトデリート済みなら復帰不可等の挙動を整理し、APIレスポンスを確認する。
- [x] `/api/log/:id/restore` が期間履歴やダッシュボードキャッシュを更新するよう確認する。
- [x] MealLog削除時の履歴整合性（`MealLogPeriodHistory` 含む）をテストで確認する。
- [x] 期間フィルター・削除/復元シナリオの統合テストを追加する。

### Phase 3: ダッシュボード & 履歴 UI更新（モバイル）
- [x] ダッシュボード初期表示を日表示に変更し、期間切替UIを更新する。
- [x] 食事履歴画面に期間フィルターUI（今日/週/2週/3週/月）を追加し、初期状態を「今日のみ」に設定する。
- [x] 食事履歴リストに削除導線（スワイプ or メニュー）を追加し、削除後のキャッシュを同期する。
- [x] 食事ログ詳細画面に時間履歴表示（`time_history`）を追加する。
- [x] 変更箇所のUIテスト／E2E手動チェック手順を整備する。

### Phase 4: チャット周辺改善
- [x] チャット画面に「新規登録」ボタンを設置し、`submitMeal` フローに接続する。
- [x] チャットの分析カードから編集画面へ遷移できるよう導線を追加する。
- [x] 編集結果をチャットタイムラインに反映・再表示するロジックを実装する。
- [x] 時間帯情報をチャットカードに表示し、手動変更時に更新されるようにする。

### Phase 5: 設定画面全面リニューアル
- [x] 設定トップの情報設計を再編し、主要セクションを定義する（アカウント／通知／法務など）。
- [x] 言語設定UIを「English」「日本語」などローカライズ表記で再設計する。
- [x] プライバシーポリシー・利用規約リンク（WebView or 外部遷移）を実装する。
- [x] アカウント管理セクションでログアウト、パスワード変更、アカウント削除BG APIを接続する。
- [x] 通知・リマインダー設定のプレースホルダーUIとOS許諾情報の同期（未定義部分はモック状態で表示）。
- [x] 目標値カスタマイズ＆プロフィール入力フォームを実装し、サーバーAPIへ接続する。
- [x] フィードバック・お問い合わせフォームの送信経路（メール or API）を実装する。
- [x] 「このアプリについて」にバージョン情報、OSSライセンス一覧、開発者情報を掲載する。

### Phase 6: 仕上げ & リリース準備
- [x] 各フェーズ完了時に `docs/chat-settings-expansion-plan.md` のチェックボックスを更新する。
- [x] 影響範囲の自動テスト・手動QAを実施し、不足分を洗い出す。
- [x] リリースノート作成、およびストア審査用スクリーンショット/説明文の更新内容を整理する。

---

## 依存関係メモ
- Phase 0 の合意なしには以降の仕様が確定しないため、最優先で完了させる。
- Phase 1 のDBマイグレーションが完了するまで、時間履歴やタイムゾーン対応を行うPhase 2以降には着手できない。
- Phase 3・4 (モバイル実装) は、該当APIが整った後に着手する。
- Phase 5 で必要なAPIが未実装の場合、モックデータでUIのみ先行実装するか順序を調整する。
