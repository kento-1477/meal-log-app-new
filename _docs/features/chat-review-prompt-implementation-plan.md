# チャット記録後レビュー依頼 実装計画書

## 目的
チャットでの食事記録が一定回数成功したタイミングで「レビューお願いします」イベント/モーダルを出し、アプリ内レビュー依頼につなげる（無料プランは2回、その他は3回）。

## 現状と原因
- チャット記録成功時の共通処理は `apps/mobile/app/(tabs)/chat.tsx` の `renderMealLogResult` にあるが、レビュー誘導の処理は無い。
- モーダルは利用上限/ストリークのみで、レビュー用の表示フラグやカウンタが存在しない。
- `dialog-tracker` は「見せたかどうか」のトラッキングのみで、回数カウント用途では使われていない。
- in-app review のAPI呼び出し/ストアURLのフォールバック導線が未実装。
- i18n と analytics にレビュー関連の文言/イベントが定義されていない。

## 前提/判断（実装方針）
- 「チャットで記録」= チャット画面からのログ作成成功（通常送信/お気に入り記録の両方）を対象とする。
- 無料プランは2回、その他は3回到達で1回だけ表示する（再表示はしない）。
- 表示条件が合わない場合は「保留」し、次に表示可能になったタイミングで提示する。
- 表示対象は「ユーザーIDがある場合はユーザー単位、未ログインは端末単位」で管理する。
- App Store 直接遷移のための `appStoreId` は後から設定可能にする（未設定時は in-app review のみ）。

## 実装計画（チェックリスト）

### Phase 1: レビューカウント/保留管理
- [x] `AsyncStorage` にレビュー状態（回数/保留/表示済み）を保存するトラッカーを新設する
- [x] 二重カウント防止のために「直近ログIDのキャッシュ」を保存する
- [x] ユーザーIDが無い場合はデバイスIDでキーを分ける

### Phase 2: レビューAPI呼び出し
- [x] `expo-store-review` を利用した in-app review 呼び出し関数を追加する
- [x] in-app review が利用不可な場合のフォールバック（ストアURL）を実装する
- [x] iOS App Store ID 取得用の設定フック（`appStoreId` 参照）を用意する

### Phase 3: UI/文言追加
- [x] チャット画面にレビュー依頼モーダルを追加する
- [x] i18n にレビュー依頼の文言（日本語/英語）を追加する
- [x] ボタン押下時の挙動（レビュー要求/閉じる）を実装する

### Phase 4: チャット成功導線へ接続
- [x] ログ記録成功時にレビューカウントを進め、条件達成で保留フラグを立てる
- [x] 他モーダル表示中/送信中は抑止し、解除後に表示する
- [x] 表示時に「表示済み」を記録し、再表示を防止する
- [x] レビュー表示/選択の analytics イベントを追加する

### Phase 5: QA
- [ ] 3回目の成功ログで表示されることを確認する
- [ ] 4回目以降は再表示されないことを確認する
- [ ] 利用上限/ストリークモーダルと同時に出ないことを確認する
- [ ] in-app review が使えない環境でフォールバックURLが開くことを確認する
