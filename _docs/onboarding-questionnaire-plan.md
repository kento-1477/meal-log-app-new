# オンボーディングアンケート実装計画

## 背景と目的
- 既存アプリにはログイン後即チャットへ遷移する導線しかなく、ユーザー属性や目標値を十分に取得できていない。
- 添付UIのような段階的アンケートを追加し、パーソナライズ精度と継続率を高めることが目的。
- MVPでは Apple Health 連携は導入せず、将来的に実装する方針を明記しておく。

## 現状整理
- [ ] モバイル: `/login` 後は `/(tabs)/chat` にリダイレクトするのみ。オンボーディング画面無し。
- [ ] モバイル: プロフィール編集画面は栄養目標と体重・活動レベルの直接入力に限られている。
- [ ] サーバー: `UserProfile` モデルおよび API は体重・目標値のみを扱い、アンケート用フィールドを保持できない。
- [ ] 共有スキーマ: `UserProfileSchema` が減量アンケート項目に未対応。

## 参考UIから抽出した主要要件
- [ ] ウェルカム > ゴール選択 > 基本情報 > 単位設定 > 流入元 > 現体重 > 活動レベル > プラン難易度 > 達成予測 > 完了 の多段ステップを導入。
- [ ] ゴールは最大3つまでのマルチセレクト。活動レベルやプラン難易度はプリセットボタンで選択。
- [ ] 体重入力はスライダーで調整し、BMIおよび理想体重レンジを同画面で提示。
- [ ] 単位（メートル法 / ヤード・ポンド法）と性別選択は下部シートモーダルで展開。
- [ ] 途中スキップや後で変更できる導線を用意。
- [ ] Apple Health 連携は将来対応とし、MVPでは UI 内で近日対応予定である旨を案内。

## 全体方針
- [ ] セッション取得時にオンボーディング完了状態を返し、未完了ユーザーをアンケートフローへリダイレクト。
- [ ] アンケート回答はローカル状態で保持し、ステップ遷移ごとにバリデーションを実行。
- [ ] 最終ステップでプロフィール API に一括保存し、完了後はチャット/ダッシュボードへ遷移。
- [ ] Apple Health 連携は後続イテレーションに切り出し、実装メモと TODO を残す。

## 実装タスクリスト

### データモデリング / マイグレーション
- [x] Prisma `UserProfile` に新フィールド追加（`displayName`, `gender`, `birthdate`, `heightCm`, `unitPreference`, `marketingSource`, `goals` String[], `currentWeightKg`, `targetWeightKg`, `planIntensity`, `targetDate`, `questionnaireCompletedAt`, `appleHealthLinked`）。
- [x] 既存数値カラムの `Float`/`Int` 整合と Null 許容条件を再確認。
- [x] Prisma migration 作成・適用、リグレッションがないか `test:integration` で確認。

### 共有スキーマ (`packages/shared`)
- [x] 新 enum 定義（`Gender`, `MeasurementSystem`, `ActivityLevel`, `PlanIntensity` など）および `OnboardingStatus` を追加。
- [x] `UserProfileSchema` と `UpdateUserProfileRequestSchema` を新フィールド対応に拡張し、Zod バリデーションを設定。
- [x] BMI/理想体重/目標達成日算出用の共通ユーティリティを追加。

### サーバー API
- [x] `GET /api/profile`・`PUT /api/profile` のシリアライズ/デシリアライズを新フィールドに対応。
- [x] オンボーディング完了フラグを保持・更新するロジックを実装し、必要に応じた新エンドポイント（ドラフト保存等）を検討。
- [x] `/api/session` レスポンスに `onboardingCompleted` を追加してクライアント分岐を可能に。
- [x] Apple Health 連携は後続タスクとして `TODO` コメントとドキュメントメモを残す。
- [x] サーバー側テスト（プロフィール更新・完了フラグ）を追加/更新。

### モバイル ナビゲーション & 状態管理
- [x] `app/(onboarding)` ルートグループを新設し、ルートガードを `_layout` に組み込む。
- [x] `zustand` またはコンテキストでアンケート回答ドラフトを管理。
- [x] セッションブートストラップ時に `onboardingCompleted` を監視し、未完了ならアンケートへ遷移。

### モバイル UI コンポーネント
- [x] オンボーディング共通レイアウトコンポーネント（背景グラデーション、進捗インジケーター、CTA ボタン）を作成。
- [x] ゴール選択・活動レベル・プラン難易度のプリセットボタン/チップを実装し、最大選択数やハイライトを管理。
- [x] 基本情報入力のテキスト/日付/セレクタ UI と性別・単位モーダルを作成。
- [x] 体重入力画面を実装し、BMI と理想体重レンジをリアルタイム表示。
- [x] 達成予測画面用のカードで進行予測を可視化。
- [x] Apple Health インポート導線は「近日対応予定」の案内テキストを表示。

### モバイル ビジネスロジック
- [x] 入力値バリデーション（数値範囲、最大選択数、必須項目）を定義し、ステップ遷移前に検証。
- [x] 単位変換ユーティリティ（身長・体重）と UI の相互同期処理を実装。
- [x] BMI・理想体重・達成日を算出するロジックを組み込み、表示更新を行う。
- [x] 完了時に `PUT /api/profile` を呼び出し、React Query キャッシュを更新。
- [ ] BMR/TDEE/PFC 自動計算ユーティリティで、身長・体重未入力や極端値に対するガード、脂質が総カロリー 20% を下回らない調整、基礎代謝以下へ落ちすぎない安全策を実装。

### モバイル i18n / コピー
- [x] `src/i18n/index.ts` にオンボーディング関連の文言を追加（日英）。
- [x] Apple Health 未対応の旨（「近日対応予定」）を各ステップで案内。

### 分析イベント
- [x] `analytics/track.ts` に `onboarding.step_viewed` / `onboarding.goal_selected` / `onboarding.completed` などを追加。
- [x] 各ステップでイベント発火し、所要時間や選択項目を追跡。

### 既存機能との統合
- [x] 設定>プロフィール画面で新フィールドを編集可能にし、アンケート完了後の再編集もサポート。
- [ ] ダッシュボード等で新フィールドが null の場合に備えたフォールバックを確認・修正。

### 将来対応メモ（Apple Health）
- [ ] `react-native-health` などの導入を検討し、権限要求フローとデータ同期手順を別ドキュメントに整理する。
- [ ] MVP 実装では UI 内に「Apple Health 連携は今後対応予定」と明記し、連携ボタンは非活性または説明ダイアログを表示。

### テスト & QA
- [ ] サーバー統合テストでプロフィール拡張項目の保存・取得を検証。
- [ ] モバイルの主要ステップを `@testing-library/react-native` でスナップショット/動作確認。
- [ ] iOS/Android シミュレータでキーボード挙動・レイアウト崩れを確認。

### デプロイ前準備
- [ ] 既存ユーザーの `questionnaireCompletedAt` を null 初期化し、初回ログイン時にアンケートへ誘導する運用を決定。
- [ ] リリースノートとサポートドキュメントにアンケート導入・Apple Health 将来対応予定を追記。
