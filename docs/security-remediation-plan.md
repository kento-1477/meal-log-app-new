# セキュリティ改善計画

## 現状と原因
- /debug ルートが本番でも公開され、AI 利用制限やキーの一部が漏えいしている。
- リファラル指紋を `X-Forwarded-For` から取得しており、ヘッダー偽装で無限に招待ボーナスを稼げる。
- 登録 API が既存メールを明示しており、メールアドレスの存在確認が可能。
- 認証系エンドポイントにレート制限がなく、総当たりや大量登録が容易。
- iOS アプリが ATS を無条件で無効化し、誤設定で平文通信になるリスクがある。

## 実装チェックリスト

### フェーズ1: デバッグ API の硬化
- [x] 本番では `/debug` をマウントしない、または管理者専用にする
- [x] Debug レスポンスから `GEMINI_API_KEY` に関する情報を除去
- [x] Debug での AI 実行にも `evaluateAiUsage` / `recordAiUsage` を適用

### フェーズ2: 信頼できるクライアント情報の取得
- [x] `app.set('trust proxy', …)` を設定
- [x] リファラル関連で `req.ip` / `req.socket.remoteAddress` を使用
- [x] 指紋生成時にヘッダー値へ依存しないよう修正
- [x] 短時間での紹介多発に追加の制限を導入

### フェーズ3: 登録レスポンスの非特定化
- [x] 既存メール時も一般的なエラーメッセージだけを返す
- [x] ログにだけ詳細を残し、クライアントには特定情報を出さない

### フェーズ4: 認証系レート制限
- [x] `express-rate-limit` を導入
- [x] `/api/login` と `/api/register` にレート制限を適用
- [x] `/log` など高コスト API にも適切なレート制限を適用

### フェーズ5: iOS ATS の是正
- [x] `NSAllowsArbitraryLoads` を削除し、必要ドメインのみ例外を残す

### フェーズ6: テストと検証
- [ ] `/debug` が本番設定でアクセス不可なことを確認
- [ ] リファラル API がヘッダー偽装に耐えることを確認
- [ ] レート制限が期待通り 429 を返すことを確認
- [ ] ATS 設定変更後に HTTPS 以外がブロックされることを確認
