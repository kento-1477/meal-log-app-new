# ダッシュボード刷新 実装計画（進捗管理）

## 0. 全体方針
- 目的：期間別の摂取状況と目標との差分を可視化し、次のアクションにつなげる。
- スコープ：バックエンド集計API新設、モバイルUI刷新、QA/ドキュメント。
- 運用：PRベース・CI必須。

---

## 1. 利用者シナリオ
- [x] 1.1 「今日いくら残せば目標達成か」を即時表示。
- [x] 1.2 期間比較で偏りを把握する。
- [x] 1.3 時間帯別バランスを確認する。
- [x] 1.4 栄養素の過不足をチェックする。
- [ ] 1.5 記録ゼロでも記録導線を出す。

---

## 2. API・データモデル
### 2.1 エンドポイント
- [x] 2.1.1 `GET /api/dashboard/summary?period=...&from=&to=`
- [x] 2.1.2 レスポンス整形（残量・単位・丸めを含む）
- [x] 2.1.3 `GET/PUT /api/dashboard/targets` をプレースホルダーで用意

### 2.2 集計ロジック
- [x] 2.2.1 Prisma で `userId + date + mealPeriod` 集計
- [x] 2.2.2 期間最大31日 & バリデーション
- [x] 2.2.3 mealPeriod null → `unknown` 集計
- [x] 2.2.4 編集/削除でキャッシュ無効化
- [x] 2.2.5 `dashboard:{userId}:{from}:{to}` キーのTTLキャッシュ
- [x] 2.2.6 目標値は当面固定値（config）

### 2.3 非機能 / テスト
- [x] 2.3.1 レスポンス <300ms（キャッシュ含む）を確認
- [x] 2.3.2 タイムゾーン境界の自動テスト追加
- [x] 2.3.3 ユニットテスト（ビルダー関数）
- [x] 2.3.4 Supertest で API E2E
- [x] 2.3.5 `requireAuth` 等セキュリティ再確認

---

- [x] 3.1 画面骨子構築（Header / Tabs / Charts / Table / Empty state）
- [x] 3.2 UI要件反映（期間フィルター、残量表示、チャート、エンプティ表示）
- [x] 3.3 状態管理（React Query + AsyncStorage キャッシュ）
- [x] 3.4 テスト（Jest + Storybook 任意 + Detox）

---

## 4. 実装タスク
### 4.1 バックエンド
- [x] 4.1.1 `dashboardSummary` サービス追加
- [x] 4.1.2 Prisma 集計実装
- [x] 4.1.3 レスポンス整形（単位・丸め・残量）
- [x] 4.1.4 TTLキャッシュ導入
- [x] 4.1.5 期間バリデーション/タイムゾーン対応
- [x] 4.1.6 ルート追加 `/api/dashboard/*`
- [x] 4.1.7 単体テスト（ビルダー関数）
- [x] 4.1.8 README/API仕様更新

- [x] 4.2.1 APIクライアント追加
- [x] 4.2.2 期間フィルターUI
- [x] 4.2.3 残りカロリー/PFC表示
- [x] 4.2.4 カロリーラインチャート（点線目標）
- [x] 4.2.5 PFCドーナツチャート
- [x] 4.2.6 栄養素テーブル
- [x] 4.2.7 エンプティカード + 記録導線
- [x] 4.2.8 AsyncStorage キャッシュ
- [x] 4.2.9 ローディング/エラー統一
- [x] 4.2.10 i18nラベル
- [x] 4.2.11 単体テスト更新

### 4.3 QA & パフォーマンス
- [x] 4.3.1 タイムゾーン自動テストをCIへ
- [x] 4.3.2 低スペック端末描画チェック（アニメ無効設定）
- [x] 4.3.3 データ量多い週でのチャート負荷検証
- [x] 4.3.4 オフライン→オンライン復旧挙動確認
- [x] 4.3.5 リリースノート/ドキュメント整備

---

## 5. リスク & 対策（確認用）
- タイムゾーンずれ → CIテスト追加
- キャッシュ不整合 → 編集時 invalidate
- 描画負荷 → アニメ切替
- 多言語 → APIキー英語固定、フロントで翻訳

---

## 6. 工数目安
- 仕様・デザイン: 1週
- API実装: 1.5週 ✅完了
- モバイル実装: 2週
- QA/調整: 0.5週
- Docs/リリース: 0.5週

---

## 7. 次アクション
- [ ] Figmaモック作成
- [ ] API仕様書ドラフト共有
- [ ] チケット整理（API/UI/チャート/QA）
- [ ] ブランチ保護確認
- [ ] モバイル実装開始
