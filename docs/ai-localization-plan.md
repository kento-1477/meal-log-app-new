# 多言語対応のための AI 応答ローカライズ基盤

## 現状把握

- [ ] AI（Gemini）が返す料理名・内訳などは英語のまま保存され、UI でもそのまま表示されている
- [ ] `processMealLog` はロケール情報を受け取らず、単一の `aiRaw` を JSON で保存している
- [ ] クライアント（モバイル）はロケール設定を持たず、API にロケール指定を渡していない
- [ ] 過去に保存済みのログは英語のみで、他言語への変換手段が用意されていない

## 目標

- [ ] モバイル → サーバー → AI の経路にロケール指定（例: `ja-JP`）を渡せるようにする
- [ ] サーバーで AI 応答をロケール別に保存し、クライアントが希望する言語を取得できるようにする
- [ ] 将来の言語切り替え（例: 日本語 ↔ 英語）に備え、翻訳データを拡張しやすい構造にする
- [ ] 既存ログも後から日本語を追加できるよう、移行・追補手段を用意する

## Step 1: 仕様・データモデル整備

- [x] ロケール表現の統一（`locale` は BCP 47 形式、例: `ja-JP`）
- [x] `aiRaw` に `translations` プロパティ（例: `translations: { 'ja-JP': {...}, 'en-US': {...} }`）を追加する仕様策定
- [x] API リクエスト/レスポンス仕様書を更新（`docs/localization-api.md` を新規作成）

## Step 2: サーバー実装

- [x] `post /log` 等でロケールを受け取るパラメータを追加しバリデーション
- [x] `processMealLog` へロケール引数を追加し、AI 呼び出し時にプロンプトへ反映
- [x] 返却された料理名・内訳を `translations[locale]` に格納、既存 `foodItem` などの互換性を維持
- [x] 既存の `getMealLogDetail` / `getLogs` / `getMealLogShare` / `getLogsExport` でロケールを指定できるようにし、該当言語が無い場合はフォールバックを返す
- [x] セッションやクエリからロケールを取得する仕組みを追加（将来の設定画面で利用）

## Step 3: モバイル実装

- [x] 送信側（`postMealLog`）に現在のアプリロケールを添付する
- [x] ストア／設定でロケールを選択できるようプロパティ追加（現在は固定で `ja-JP`）
- [x] 取得系 API 呼び出し（ダッシュボード、履歴、詳細、エクスポート等）にロケールを渡し、レスポンスから `translations` を優先的に表示
- [x] UI でフォールバックが発生した際にはユーザーに言語未対応であることを示す表示（任意）

## Step 4: 既存データの追補

- [ ] Prisma Migration で `MealLog.aiRaw` の JSON スキーマに `translations` を追加
- [ ] バッチスクリプトを用意し、既存ログに対して `translations['ja-JP']` を生成
  - [ ] AI に再問い合わせする（コスト高） or 外部翻訳 API を利用する（スクリプト化）
  - [ ] 進捗ログやリトライ戦略を設計
- [ ] バッチの手順を `docs/` に記載

## Step 5: テスト & QA

- [x] サーバー単体テストでロケール指定時の入出力を網羅（`tests/localization-service.test.ts` 追加）
- [x] モバイルのコンポーネントテストでロケール表示を確認（`tests/localization.test.ts` 追加）
- [x] 手動テストチェックリスト作成（`docs/localization-qa-checklist.md`）

## Step 6: 運用・将来拡張

- [ ] 設定画面に言語選択 UI を追加するタスクを別途起票
- [ ] API から返すサポート言語一覧エンドポイント検討
- [ ] 翻訳データが増えた場合のストレージ・パフォーマンスモニタリング

## 補足

- 既存の `aiRaw` を直接書き換えるのではなく、`translations` を増やす形にしておくと、元の英語データを残したまま他言語を追加できる
- フォールバック順（例: 選択言語 → 日本語 → 英語）を決めておくと表示が安定
- `locale` 情報は今後ユーザー設定やログ共有にも活かせるため、早めにプロトコル化しておくと管理が楽になる
